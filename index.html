<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jessie Math - ä¸‰è§’å½¢å¹¾ä½•ç‹åœ‹</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- âœ… å¿«å–é€£çµé è¦½ï¼ˆè«‹æ”¾åœ¨ <head> è£¡ï¼‰ -->
  <meta name="description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
  <!-- âœ… LINE / FB é è¦½ç”¨ -->
  <meta property="og:title" content="Jessie Math - ä¸‰è§’å½¢å¹¾ä½•ç‹åœ‹">
  <meta property="og:description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
  <meta property="og:type" content="website">

  <!-- âœ… é è¦½åœ–ç‰‡-->
  <meta property="og:image" content="g4-u7-1.png">
  <meta property="og:image:width" content="1024">
  <meta property="og:image:height" content="1536">
  <meta property="og:image:alt" content="Jessie Math éŠæˆ²å°é¢">

  <!-- âœ… æœ‰äº›å¹³å°æœƒåƒè€ƒ -->
  <link rel="image_src" href="g4-u7-1.png">

  <!-- âœ… Twitter / Xï¼ˆå¯ç”¨åŒä¸€å¼µåœ–ï¼‰ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Jessie Math - ä¸‰è§’å½¢å¹¾ä½•ç‹åœ‹">
  <meta name="twitter:description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
  <meta name="twitter:image" content="g4-u7-1.png">

  <!-- âœ… KaTeXï¼šè®“ \(\overline{BC}\) é€™ç¨®å¯«æ³•èƒ½ç›´æ¥é¡¯ç¤º -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

  <style>
    :root{
      --primary-yellow:#FFD700;
      --bg-color:#f0f8ff;
      --accent-blue:#007bff;
      --ok:#28a745;
      --bad:#e53935;
      --ink:#1f2937;
      --soft:#f8f9fa;
      --card:#ffffff;
      --shadow:0 10px 30px rgba(0,0,0,.10);
      --radius:20px;
    }

    *{box-sizing:border-box}
    body{
      font-family: "Microsoft JhengHei", system-ui, -apple-system, Segoe UI, sans-serif;
      margin:0;
      background:var(--bg-color);
      color:var(--ink);
      overflow-x:hidden;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:15px 30px;
      background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      position:sticky;
      top:0;
      z-index:10;
    }

    .brand-container{display:flex;align-items:center;gap:15px;}
    .logo-circle{
      width:80px;height:80px;
      border:4px solid var(--primary-yellow);
      border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      background:transparent;
      flex:0 0 auto;
    }
    .logo-circle img{width:90%;height:90%;object-fit:contain;}
    .brand-title{font-size:24px;font-weight:900;letter-spacing:.5px}

    .nav-buttons{display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end}
    .nav-btn{
      padding:10px 14px;
      border-radius:25px;
      text-decoration:none;
      color:#333;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:8px;
      background:#eee;
      transition:.2s;
      user-select:none;
    }
    .nav-btn:hover{background:var(--primary-yellow);transform:translateY(-1px)}
    .btn-back{background:#ffecb3}

    .page{
      display:none;
      max-width:980px;
      margin:26px auto 40px;
      padding:26px;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      text-align:center;
    }
    .active-page{display:block;}

    h1,h2,h3{margin:10px 0}
    .sub{
      opacity:.8;
      margin-top:6px;
      font-weight:700;
    }

    .input-group{margin:22px 0 10px;}
    input[type="text"]{
      padding:12px;
      width:min(320px, 90%);
      border-radius:12px;
      border:2px solid #ddd;
      font-size:1.05em;
      outline:none;
    }
    input[type="text"]:focus{border-color:var(--primary-yellow); box-shadow:0 0 0 4px rgba(255,215,0,.25);}

    .game-desc{
      background:#fff9e6;
      padding:18px 18px;
      border-radius:16px;
      text-align:left;
      margin:14px auto 18px;
      max-width:860px;
      line-height:1.55;
    }
    .game-desc ul{margin:10px 0 0 20px}
    .pill-row{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin:10px 0 0;
    }
    .pill{
      background:#eef6ff;
      border:1px solid rgba(0,123,255,.15);
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      color:#0b5ed7;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .start-btn{
      background:var(--ok);
      color:white;
      padding:14px 40px;
      font-size:1.15em;
      border:none;
      border-radius:30px;
      cursor:pointer;
      margin-top:14px;
      font-weight:900;
      transition:.2s;
    }
    .start-btn:hover{filter:brightness(1.05); transform:translateY(-1px)}

    .difficulty-select{
      margin:16px auto 6px;
      padding:14px;
      background:#e3f2fd;
      border-radius:14px;
      max-width:860px;
      text-align:left;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    select{
      padding:8px 10px;
      border-radius:10px;
      border:2px solid rgba(0,0,0,.08);
      font-weight:800;
      outline:none;
    }

    .level-grid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:16px;
      margin-top:18px;
    }
    .level-card{
      padding:22px 16px;
      background:var(--soft);
      border-radius:16px;
      cursor:pointer;
      border:3px solid transparent;
      transition:.2s;
      text-align:left;
      min-height:150px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .level-card:hover{border-color:var(--primary-yellow); transform:translateY(-4px)}
    .level-card h3{margin:8px 0 4px}
    .level-card p{margin:0; opacity:.85; font-weight:700}

    .stats-bar{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin:0 auto 14px;
      font-weight:900;
      color:var(--accent-blue);
      flex-wrap:wrap;
      max-width:920px;
    }
    .stat{
      background:#eef6ff;
      border:1px solid rgba(0,123,255,.12);
      padding:10px 12px;
      border-radius:14px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .game-wrap{
      max-width:920px;
      margin:0 auto;
      text-align:left;
      background:#fff;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.06);
      padding:18px;
      position:relative;
    }

    .q-meta{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:10px;
    }
    .q-badge{
      background:#fff9e6;
      border:1px solid rgba(255,183,0,.25);
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .q-title{
      font-size:1.15em;
      font-weight:900;
      margin:8px 0 14px;
      line-height:1.55;
    }

    .choices{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .choice-btn{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:2px solid rgba(0,0,0,.10);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      text-align:left;
      transition:.15s;
      display:flex;
      gap:10px;
      align-items:flex-start;
      line-height:1.35;
    }
    .choice-btn:hover{border-color:rgba(255,215,0,.9); box-shadow:0 0 0 4px rgba(255,215,0,.20)}
    .choice-key{
      width:28px;height:28px;border-radius:10px;
      background:#f3f4f6;
      display:flex;align-items:center;justify-content:center;
      flex:0 0 auto;
      font-weight:900;
    }

    .feedback{
      margin-top:14px;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      display:none;
      line-height:1.55;
    }
    .feedback.ok{display:block;background:rgba(40,167,69,.10); border:1px solid rgba(40,167,69,.25); color:#157347}
    .feedback.bad{display:block;background:rgba(229,57,53,.10); border:1px solid rgba(229,57,53,.25); color:#b71c1c}

    .controls-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:14px;
      flex-wrap:wrap;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      background:#eee;
      transition:.15s;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--primary-yellow)}
    .btn-ghost{background:#f3f4f6}
    .btn-danger{background:#ffd6d6}
    .btn-ok{background:#d1fae5}
    .btn-pause{background:#e0e7ff}

    .divider{margin:26px 0;border:none;border-top:1px solid rgba(0,0,0,.08)}

    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px;}
    th,td{padding:10px; border-bottom:1px solid rgba(0,0,0,.06); text-align:left; font-weight:900;}
    thead th{background:#eee}
    tbody tr:hover{background:#fafafa}

    footer{
      max-width:980px;
      margin:0 auto 26px;
      padding:0 14px;
    }
    .footer-pill{
      /* âœ… ä¾ä½ çš„è¦æ±‚ï¼šèƒŒæ™¯æ”¹ç™½è‰²ï¼ˆåŸæœ¬é»‘è‰²ï¼‰ */
      background:#ffffff;
      color:var(--ink);
      border-radius:999px;
      padding:12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      box-shadow:0 14px 30px rgba(15,23,42,.12);
      border:1px solid rgba(0,0,0,.08);
    }
    .footer-left{display:flex;align-items:center;gap:10px}
    .footer-dot{width:10px;height:10px;border-radius:50%;background:var(--primary-yellow)}
    .footer-copy{font-weight:900;opacity:.95}
    .footer-right{display:flex;align-items:center;gap:10px;opacity:.95;font-weight:900}
    .footer-icon{width:28px;height:28px;border-radius:10px;background:rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center}

    .q-figure{
      margin:10px 0 14px;
      background:#f8fafc;
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:12px;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .q-figure img{
      max-width:100%;
      height:auto;
      border-radius:12px;
    }

    .pause-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.70);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding:18px;
    }
    .pause-card{
      width:min(560px, 94vw);
      background:#fff;
      border-radius:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      padding:18px 18px 16px;
      text-align:center;
    }
    .pause-title{
      font-size:1.25em;
      font-weight:900;
      margin:6px 0 6px;
      color:#0f172a;
    }
    .pause-sub{
      font-weight:800;
      opacity:.85;
      line-height:1.6;
      margin:0 0 12px;
    }
    .pause-row{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:10px;
    }

    /* âœ… RWDï¼šè£œå¼·æ‰‹æ©Ÿ/å¹³æ¿/é›»è…¦æ¯”ä¾‹ï¼ˆä¸å‹•åŠŸèƒ½ï¼ŒåªåŠ æ’ç‰ˆä¿éšªï¼‰ */
    @media (max-width: 1024px){
      .page{max-width:920px}
      .level-grid{grid-template-columns:repeat(2, 1fr);}
      .choices{grid-template-columns:1fr;}
      .game-wrap{padding:16px}
      table{display:block; overflow-x:auto; -webkit-overflow-scrolling:touch;}
    }

    @media (max-width: 860px){
      header{padding:12px 14px}
      .logo-circle{width:68px;height:68px}
      .brand-title{font-size:22px}
      .page{margin:18px 10px; padding:18px}
      .level-grid{grid-template-columns:1fr; }
      .choices{grid-template-columns:1fr;}
      .difficulty-select{justify-content:flex-start}
      .nav-buttons{justify-content:flex-start}
      .footer-pill{border-radius:22px}
    }

    @media (max-width: 420px){
      .brand-title{font-size:20px}
      .nav-btn{padding:9px 12px}
      .q-title{font-size:1.05em}
      .choice-key{width:26px;height:26px;border-radius:9px}
      .btn{width:100%; justify-content:center}
      .controls-row{gap:8px}
    }
  </style>
</head>

<body>
<header>
  <div class="brand-container">
    <div class="logo-circle">
      <img src="JESSIEMATH-Q.png" alt="Jessie Math Logo">
    </div>
    <span class="brand-title">Jessie Math</span>
  </div>

  <div class="nav-buttons">
    <a href="https://jessiemath0703-chu.github.io/website2/" class="nav-btn">
      <i class="fas fa-home"></i>é¦–é 
    </a>
    <a href="https://jessiemath0703-chu.github.io/Game-Lobby/" class="nav-btn">
      <i class="fas fa-gamepad"></i>éŠæˆ²å¤§å»³
    </a>
    <a href="https://jessiemath0703-chu.github.io/Game-Lobby/#g4-u7" class="nav-btn btn-back">
      <i class="fas fa-arrow-left"></i>å››å¹´ç´šä¸‰è§’å½¢èˆ‡å…¨ç­‰
    </a>
  </div>
</header>

<section id="welcome-page" class="page active-page">
  <h1>ğŸ“ ä¸‰è§’å½¢å¤§å†’éšª</h1>
  <div class="sub">æŠŠè§’åº¦èˆ‡é‚Šé•·ï¼Œæ”¶é€²ä½ çš„ç‹å† è£¡ã€‚ä»Šå¤©ä½ å°±æ˜¯å¹¾ä½•ä¸»è§’ âœ¨</div>

  <div class="pill-row">
    <div class="pill"><i class="fa-solid fa-stopwatch"></i>è¨ˆæ™‚è¡åˆº</div>
    <div class="pill"><i class="fa-solid fa-bolt"></i>ç­”éŒ¯æ‰£ç§’</div>
    <div class="pill"><i class="fa-solid fa-trophy"></i>æ’è¡Œæ¦œ</div>
  </div>

  <div class="game-desc">
    <h3 style="margin:0 0 8px;">ğŸ“œ éŠæˆ²èªªæ˜</h3>
    <ul>
      <li><b>ç¬¬ä¸€é—œï½œåˆ†é¡å¤§è€ƒé©—ï¼š</b>è¾¨èªéŠ³è§’ã€ç›´è§’ã€éˆè§’èˆ‡ç­‰è…°/æ­£ä¸‰è§’å½¢ç­‰æ¦‚å¿µã€‚</li>
      <li><b>ç¬¬äºŒé—œï½œç•«åœ–å°é«˜æ‰‹ï¼š</b>æ ¹æ“šã€Œç•«æ³•æè¿°ã€åˆ¤æ–·èƒ½ç•«å‡ºå“ªç¨®ä¸‰è§’å½¢ã€‚</li>
      <li><b>ç¬¬ä¸‰é—œï½œå…¨ç­‰åµæ¢ï¼š</b>æ‰¾å°æ‡‰é»ã€å°æ‡‰è§’ã€å°æ‡‰é‚Šï¼ˆå¯æ—‹è½‰/ç¿»è½‰/ä¸Šä¸‹é¡›å€’ï¼‰ã€‚</li>
      <li><b>å‡ºé¡Œï¼š</b>é¡Œç›®æœƒä¸€ç›´éš¨æ©Ÿè®ŠåŒ–ï¼ˆä¸å›ºå®šé †åºã€ä¸å›ºå®šé¡Œå‹ï¼‰ã€‚</li>
      <li><b>è¨ˆåˆ†ï¼š</b>ç­”å°åŠ åˆ†ï¼Œè¶Šå¿«åŠ è¶Šå¤šï¼›ç­”éŒ¯æœƒæ‰£åˆ†ä¸¦æ‰£ç§’ã€‚</li>
    </ul>
  </div>

  <div class="input-group">
    <input type="text" id="player-name" placeholder="è«‹è¼¸å…¥å‹‡è€…å§“å..." maxlength="16" />
  </div>

  <button class="start-btn" onclick="goToLobby()">
    é€²å…¥æŒ‘æˆ° <i class="fa-solid fa-arrow-right"></i>
  </button>
</section>

<section id="lobby-page" class="page">
  <h2>å‹‡è€… <span id="display-name"></span>ï¼Œè«‹é¸æ“‡é—œå¡</h2>
  <div class="sub">é¸ä¸€æ‰‡é–€ï¼Œèµ°é€²ä¸‰è§’å½¢çš„å…‰ã€‚</div>

  <div class="difficulty-select">
    <div style="display:flex;align-items:center;gap:10px;">
      <i class="fa-solid fa-gauge-high" style="color:#0b5ed7;"></i>
      <b>é›£æ˜“åº¦ï¼ˆé€Ÿåº¦ï¼‰</b>
      <span style="opacity:.75;font-weight:800;">å½±éŸ¿ï¼šç¸½æ™‚é–“ã€åŠ æˆå€ç‡</span>
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
      <label for="speed-select" style="font-weight:900;">æ¨¡å¼ï¼š</label>
      <select id="speed-select">
        <option value="slow">æ…¢é€Ÿï¼ˆç·´ç¿’æ¨¡å¼ï¼‰</option>
        <option value="normal" selected>æ­£å¸¸ï¼ˆå†’éšªæ¨¡å¼ï¼‰</option>
        <option value="fast">ç–¾é€Ÿï¼ˆå‚³èªªæ¨¡å¼ï¼‰</option>
      </select>
    </div>
  </div>

  <div class="level-grid">
    <div class="level-card" onclick="startLevel(1)">
      <div>
        <i class="fas fa-layer-group fa-3x" style="color:#e91e63;"></i>
        <h3>ç¬¬ä¸€é—œ</h3>
        <p>ä¸‰è§’å½¢çš„åˆ†é¡</p>
      </div>
      <div style="opacity:.85;font-weight:900;">è§’åº¦èˆ‡é‚Šé•·ï¼šèª°åœ¨ç™¼å…‰ï¼Ÿ</div>
    </div>

    <div class="level-card" onclick="startLevel(2)">
      <div>
        <i class="fas fa-pencil-alt fa-3x" style="color:#4caf50;"></i>
        <h3>ç¬¬äºŒé—œ</h3>
        <p>ç•«ä¸‰è§’å½¢</p>
      </div>
      <div style="opacity:.85;font-weight:900;">çœ‹ã€Œç•«æ³•ã€çŒœåœ–å½¢ï¼šä½ çš„è…¦å…§å°ºè¶…æº–ã€‚</div>
    </div>

    <div class="level-card" onclick="startLevel(3)">
      <div>
        <i class="fas fa-clone fa-3x" style="color:#2196f3;"></i>
        <h3>ç¬¬ä¸‰é—œ</h3>
        <p>èªè­˜å…¨ç­‰</p>
      </div>
      <div style="opacity:.85;font-weight:900;">ç¿»è½‰ã€æ—‹è½‰éƒ½ä¸æ€•ï¼šå°æ‡‰é—œä¿‚æ‰æ˜¯ä¸»è§’ã€‚</div>
    </div>
  </div>

  <hr class="divider" />

  <h3 style="margin:0 0 10px;">ğŸ† å³æ™‚æ’è¡Œæ¦œï¼ˆæœ¬æ©Ÿï¼‰</h3>
  <div class="sub" style="margin:0 0 12px;">æ¯å€‹ç©å®¶æœƒè¨˜éŒ„ä¸‰å€‹é—œå¡çš„ã€Œæœ€é«˜åˆ†ã€ã€‚</div>

  <div style="max-width:920px;margin:0 auto;">
    <table>
      <thead>
        <tr>
          <th style="width:80px;">åæ¬¡</th>
          <th>ç©å®¶</th>
          <th style="width:120px;">ç¬¬ä¸€é—œ</th>
          <th style="width:120px;">ç¬¬äºŒé—œ</th>
          <th style="width:120px;">ç¬¬ä¸‰é—œ</th>
          <th style="width:140px;">ç¸½å’Œ</th>
          <th style="width:140px;">æ—¥æœŸ</th>
        </tr>
      </thead>
      <tbody id="lb-body"></tbody>
    </table>
  </div>
</section>

<section id="game-page" class="page">
  <div class="stats-bar">
    <div class="stat"><span>ğŸ•’</span>æ™‚é–“ï¼š<span id="timer">0</span>s</div>
    <div class="stat"><span>âœ¨</span>å¾—åˆ†ï¼š<span id="score">0</span></div>
    <div class="stat"><span>ğŸ§©</span>é—œå¡ï¼š<span id="current-level-name"></span></div>
    <div class="stat"><span>ğŸ¯</span><span id="q-progress">ç¬¬ 1 é¡Œ</span></div>
  </div>

  <div class="game-wrap">
    <div class="q-meta">
      <div class="q-badge"><i class="fa-solid fa-feather-pointed"></i><span id="mode-badge">æ¨¡å¼ï¼šæ­£å¸¸</span></div>
      <div class="q-badge"><i class="fa-solid fa-heart-pulse"></i><span id="streak-badge">é€£å°ï¼š0</span></div>
    </div>

    <div id="game-content"></div>

    <div id="feedback" class="feedback"></div>

    <div class="controls-row">
      <button class="btn btn-ghost" onclick="backToLobby()"><i class="fa-solid fa-arrow-left"></i>è¿”å›é—œå¡é¸æ“‡</button>
      <button class="btn btn-pause" onclick="togglePause(true)"><i class="fa-solid fa-pause"></i>æš«åœ</button>
      <button class="btn btn-danger" onclick="restartConfirm()"><i class="fa-solid fa-rotate-left"></i>é‡ä¾†</button>

      <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()" style="display:none;">
        ä¸‹ä¸€é¡Œ <i class="fa-solid fa-arrow-right"></i>
      </button>
    </div>
  </div>
</section>

<div id="pause-overlay" class="pause-overlay" aria-hidden="true">
  <div class="pause-card" role="dialog" aria-modal="true" aria-label="æš«åœä¸­">
    <div class="pause-title">â¸ å·²æš«åœ</div>
    <div class="pause-sub">é¡Œç›®å…ˆè“‹èµ·ä¾†ï¼Œå…¬å¹³åƒ \(\overline{BC}\) ä¸€æ¨£ç›´æŒºæŒºã€‚<br>å›ä¾†å°±ç¹¼çºŒï¼Œåˆ¥è®“éˆæ„Ÿè·‘æ‰ã€‚</div>
    <div class="pause-row">
      <button class="btn btn-ok" onclick="togglePause(false)"><i class="fa-solid fa-play"></i>ç¹¼çºŒ</button>
      <button class="btn btn-danger" onclick="restartConfirm()"><i class="fa-solid fa-rotate-left"></i>é‡ä¾†</button>
      <button class="btn btn-ghost" onclick="backToLobby()"><i class="fa-solid fa-door-open"></i>å›å¤§å»³</button>
    </div>
  </div>
</div>

<footer>
  <div class="footer-pill">
    <div class="footer-left">
      <div class="footer-dot" aria-hidden="true"></div>
      <div class="footer-copy">Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.</div>
    </div>
    <div class="footer-right">
      <div class="footer-icon" aria-hidden="true"><i class="fas fa-compass"></i></div>
      <div class="footer-tagline">æ•¸å­¸ä¸è¿·è·¯ï¼ŒJessie å¸¶ä½ èµ°å‘ç†è§£ã€‚</div>
    </div>
  </div>
</footer>

<script>
/* =========================
   âœ… å”¯ä¸€æ›´æ”¹ï¼šç¬¬ä¸€é—œã€Œéˆè§’é¡Œã€æ©˜è‰²åœ“å¼§æ”¹ç‚ºã€ŒçœŸæ­£è²¼åœ¨è§’ä¸Šã€çš„åœ“å¼§
   - ç”¨å…©æ¢é‚Šçš„æ–¹å‘å‘é‡ç®—å‡ºåœ“å¼§èµ·é»/çµ‚é»
   - åœ“å¼§æœƒã€ŒåŒ…å¥½ã€é‚£å€‹è§’ï¼Œä¸æœƒé£„åˆ°é‚Šä¸Š
   å…¶ä»–å…¨éƒ¨ä¸å‹•
========================= */

const $ = (sel) => document.querySelector(sel);

const state = {
  playerName: "",
  speed: "normal",
  level: 1,
  score: 0,
  timer: 0,
  tick: null,
  streak: 0,
  answered: false,
  paused: false,
  autoNext: null,
  qNo: 1,
  recentSig: [],
  currentQ: null
};

const SPEED = {
  slow:   { label:"æ…¢é€Ÿ",   time: 90, mult: 0.95, wrongPenalty: 3, wrongScore: 40 },
  normal: { label:"æ­£å¸¸",   time: 60, mult: 1.00, wrongPenalty: 4, wrongScore: 50 },
  fast:   { label:"ç–¾é€Ÿ",   time: 45, mult: 1.15, wrongPenalty: 5, wrongScore: 60 },
};

const LEVEL_NAME = {
  1: "ä¸‰è§’å½¢çš„åˆ†é¡",
  2: "ç•«ä¸‰è§’å½¢",
  3: "èªè­˜å…¨ç­‰",
};

function renderMath(){
  try{
    if(window.renderMathInElement){
      renderMathInElement(document.body, {
        delimiters: [
          {left: "\\(", right: "\\)", display: false},
          {left: "\\[", right: "\\)", display: true}
        ]
      });
    }
  }catch(e){}
}

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function clamp(n,min,max){return Math.max(min, Math.min(max,n));}
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function seg(s){ return `\\(\\overline{${s}}\\)`; }

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function ensureUniqueChoices(question){
  const orig = question.choices.map(String);
  const seen = new Set();
  const uniq = [];
  for(const c of orig){
    if(!seen.has(c)){
      seen.add(c);
      uniq.push(c);
    }
  }
  const correctText = String(orig[question.a]);
  if(!uniq.includes(correctText)){
    uniq.unshift(correctText);
  }
  let newA = uniq.indexOf(correctText);

  const fillerPool = [
    "é» A","é» B","é» C","é» D",
    "âˆ A","âˆ B","âˆ C","âˆ D",
    seg("AB"),seg("AC"),seg("BC"),seg("DE"),seg("EF"),seg("DF")
  ].map(String);

  let i = 0;
  while(uniq.length < 3 && i < fillerPool.length){
    const cand = fillerPool[i++];
    if(!uniq.includes(cand) && cand !== correctText){
      uniq.push(cand);
    }
  }

  let final = uniq.length >= 4 ? uniq.slice(0,4) : uniq.slice(0,3);
  final = shuffle(final);
  newA = final.indexOf(correctText);
  if(newA < 0){
    final[0] = correctText;
    newA = 0;
    final = shuffle(final);
    newA = final.indexOf(correctText);
  }
  return { ...question, choices: final, a: newA };
}

function switchPage(id){
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active-page"));
  document.getElementById(id).classList.add("active-page");
  setTimeout(renderMath, 0);
}

function goToLobby(){
  const name = $("#player-name").value.trim();
  if(!name){
    alert("è«‹å…ˆè¼¸å…¥åå­—å“¦ï¼");
    return;
  }
  state.playerName = name;
  $("#display-name").innerText = name;
  renderLeaderboard();
  switchPage("lobby-page");
}

/* ======== æ’è¡Œæ¦œ ======== */
const LB_KEY = "jm_g4u7_leaderboard_levels_v1";
function loadLB(){
  try{
    const raw = localStorage.getItem(LB_KEY);
    const data = raw ? JSON.parse(raw) : [];
    return Array.isArray(data) ? data : [];
  }catch(e){ return []; }
}
function saveLB(list){ localStorage.setItem(LB_KEY, JSON.stringify(list)); }
function upsertLevelScore(name, level, score){
  const now = new Date();
  const stamp = now.toLocaleDateString("zh-Hant", { year:"numeric", month:"2-digit", day:"2-digit" });
  let lb = loadLB();
  let row = lb.find(x => x.name === name);
  if(!row){
    row = { name, l1:0, l2:0, l3:0, date: stamp };
    lb.push(row);
  }
  const key = level===1 ? "l1" : level===2 ? "l2" : "l3";
  if(score > (row[key] || 0)){
    row[key] = score;
    row.date = stamp;
  }
  lb.sort((a,b)=> ((b.l1+b.l2+b.l3) - (a.l1+a.l2+a.l3)));
  lb = lb.slice(0,5);
  saveLB(lb);
}
function renderLeaderboard(){
  const lb = loadLB();
  const body = $("#lb-body");
  body.innerHTML = "";
  if(lb.length === 0){
    body.innerHTML = `<tr><td colspan="7" style="opacity:.75;font-weight:900;">ç›®å‰é‚„æ²’æœ‰ç´€éŒ„ï¼Œå¿«å»æ‹¿ç¬¬ä¸€åå§ âœ¨</td></tr>`;
    return;
  }
  lb.forEach((row, i) => {
    const medal = i===0 ? "ğŸ¥‡" : i===1 ? "ğŸ¥ˆ" : i===2 ? "ğŸ¥‰" : "â­";
    const total = (row.l1||0) + (row.l2||0) + (row.l3||0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${medal} ${i+1}</td>
      <td>${escapeHtml(row.name)}</td>
      <td>${row.l1||0}</td>
      <td>${row.l2||0}</td>
      <td>${row.l3||0}</td>
      <td>${total}</td>
      <td>${row.date || ""}</td>
    `;
    body.appendChild(tr);
  });
}

/* ======== SVG å·¥å…· ======== */
function svgToDataUri(svg){
  const cleaned = svg
    .replace(/\n+/g, "")
    .replace(/\s{2,}/g, " ")
    .replace(/"/g, "'");
  return "data:image/svg+xml;utf8," + encodeURIComponent(cleaned);
}

function makeTriLabels(){
  const sets = [
    ["A","B","C"],
    ["P","Q","R"],
    ["D","E","F"],
    ["M","N","K"],
  ];
  return choice(sets);
}

/* =========================
   ç¬¬ä¸€é—œï¼šåœ–å½¢æ¨™ç¤ºï¼ˆç­‰è…°/æ­£ä¸‰è§’å½¢/ç›´è§’ä¸è®Šï¼‰
========================= */

function makeRightTri(){
  const [A,B,C] = makeTriLabels();
  const x1 = randInt(120,160), y1 = 280;
  const x2 = x1, y2 = randInt(80,120);
  const x3 = randInt(430,500), y3 = 280;
  const s = 36;

  return svgToDataUri(`
    <svg xmlns="http://www.w3.org/2000/svg" width="640" height="360" viewBox="0 0 640 360">
      <rect width="100%" height="100%" fill="#ffffff"/>
      <g stroke="#111827" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path d="M${x1} ${y1} L${x2} ${y2} L${x3} ${y3} Z"/>
      </g>
      <g stroke="#007bff" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0.95">
        <path d="M${x1} ${y1} L${x2} ${y2}" stroke-width="12"/>
        <path d="M${x1} ${y1} L${x3} ${y3}" stroke-width="12"/>
      </g>
      <g stroke="#007bff" stroke-width="10" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path d="M${x1} ${y1-s} L${x1+s} ${y1-s} L${x1+s} ${y1}"/>
      </g>
      <g fill="#111827" font-family="Microsoft JhengHei" font-weight="900" font-size="28">
        <text x="${x1-25}" y="${y1+25}">${A}</text>
        <text x="${x2-25}" y="${y2-10}">${B}</text>
        <text x="${x3+10}" y="${y3+25}">${C}</text>
      </g>
    </svg>
  `);
}

function makeIsosTri(){
  const [A,B,C] = makeTriLabels();
  const left = randInt(140,180), right = randInt(460,500);
  const topX = randInt(300,340), topY = randInt(80,110);
  const baseY = 280;

  return svgToDataUri(`
    <svg xmlns="http://www.w3.org/2000/svg" width="640" height="360" viewBox="0 0 640 360">
      <rect width="100%" height="100%" fill="#ffffff"/>
      <g stroke="#111827" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path d="M${left} ${baseY} L${topX} ${topY} L${right} ${baseY} Z"/>
      </g>
      <g stroke="#e91e63" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0.95">
        <path d="M${left} ${baseY} L${topX} ${topY}" stroke-width="12"/>
        <path d="M${topX} ${topY} L${right} ${baseY}" stroke-width="12"/>
      </g>
      <g fill="#111827" font-family="Microsoft JhengHei" font-weight="900" font-size="28">
        <text x="${left-25}" y="${baseY+25}">${A}</text>
        <text x="${topX-10}" y="${topY-10}">${B}</text>
        <text x="${right+10}" y="${baseY+25}">${C}</text>
      </g>
    </svg>
  `);
}

function makeEquiTri(){
  const [A,B,C] = makeTriLabels();
  const left = randInt(150,190), right = randInt(450,490);
  const topX = Math.round((left+right)/2), topY = randInt(90,120);
  const baseY = 280;

  return svgToDataUri(`
    <svg xmlns="http://www.w3.org/2000/svg" width="640" height="360" viewBox="0 0 640 360">
      <rect width="100%" height="100%" fill="#ffffff"/>
      <g stroke="#111827" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path d="M${left} ${baseY} L${topX} ${topY} L${right} ${baseY} Z"/>
      </g>
      <g stroke="#ffb700" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0.95">
        <path d="M${left} ${baseY} L${topX} ${topY}" stroke-width="12"/>
        <path d="M${topX} ${topY} L${right} ${baseY}" stroke-width="12"/>
        <path d="M${left} ${baseY} L${right} ${baseY}" stroke-width="12"/>
      </g>
      <g fill="#111827" font-family="Microsoft JhengHei" font-weight="900" font-size="28">
        <text x="${left-25}" y="${baseY+25}">${A}</text>
        <text x="${topX-10}" y="${topY-10}">${B}</text>
        <text x="${right+10}" y="${baseY+25}">${C}</text>
      </g>
    </svg>
  `);
}

/* âœ… å”¯ä¸€ä¿®æ”¹é»ï¼šmakeObtuseTri çš„æ©˜è‰²åœ“å¼§ï¼Œæ”¹æˆçœŸæ­£ã€ŒåŒ…ä½è§’ã€ */
function makeObtuseTri(){
  const [A,B,C] = makeTriLabels();
  const ax = randInt(110,150), ay = 270;
  const bx = randInt(380,430), by = randInt(110,140);
  const cx = randInt(520,560), cy = 280;

  // â€”â€” åœ“å¼§è¨ˆç®—ï¼šä»¥ B ç‚ºé ‚é»ï¼Œæ²¿ BA èˆ‡ BC å…©æ¢å°„ç·šå–é»
  const r = 70; // åœ“å¼§åŠå¾‘ï¼ˆå¯è¦–è¦ºæ›´æ¸…æ¥šï¼‰
  const v1x = ax - bx, v1y = ay - by; // BA
  const v2x = cx - bx, v2y = cy - by; // BC
  const l1 = Math.hypot(v1x, v1y) || 1;
  const l2 = Math.hypot(v2x, v2y) || 1;
  const u1x = v1x / l1, u1y = v1y / l1;
  const u2x = v2x / l2, u2y = v2y / l2;

  const p1x = bx + u1x * r, p1y = by + u1y * r;
  const p2x = bx + u2x * r, p2y = by + u2y * r;

  // æ±ºå®š sweepï¼šä¾å‘é‡å¤–ç©æ–¹å‘ï¼Œè®“åœ“å¼§è½åœ¨å…©é‚Šä¹‹é–“
  const cross = u1x * u2y - u1y * u2x;
  const sweep = cross >= 0 ? 1 : 0;

  const arcPath = `M${p1x.toFixed(1)} ${p1y.toFixed(1)} A${r} ${r} 0 0 ${sweep} ${p2x.toFixed(1)} ${p2y.toFixed(1)}`;

  return svgToDataUri(`
    <svg xmlns="http://www.w3.org/2000/svg" width="640" height="360" viewBox="0 0 640 360">
      <rect width="100%" height="100%" fill="#ffffff"/>
      <g stroke="#111827" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path d="M${ax} ${ay} L${bx} ${by} L${cx} ${cy} Z"/>
      </g>

      <!-- âœ… éˆè§’åœ“å¼§ï¼šçœŸæ­£è²¼åœ¨é ‚é» B çš„å…©é‚Šä¹‹é–“ï¼Œä¹¾æ·¨åŒ…ä½é‚£å€‹è§’ -->
      <g stroke="#ff5722" stroke-width="12" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0.95">
        <path d="${arcPath}"/>
      </g>

      <g fill="#111827" font-family="Microsoft JhengHei" font-weight="900" font-size="28">
        <text x="${ax-25}" y="${ay+25}">${A}</text>
        <text x="${bx-20}" y="${by-10}">${B}</text>
        <text x="${cx+10}" y="${cy+25}">${C}</text>
      </g>
    </svg>
  `);
}

/* ========= âœ… ç¬¬ä¸‰é—œå…¨ç­‰åœ–ï¼šä¸è£åˆ‡ + æ¨™ç¤ºæ°¸é è²¼åœ¨ç·šä¸Šï¼ˆåŸæ¨£ä¿ç•™ï¼‰ ========= */
function pt(x,y){ return {x,y}; }
function add(a,b){ return {x:a.x+b.x, y:a.y+b.y}; }
function sub(a,b){ return {x:a.x-b.x, y:a.y-b.y}; }
function mul(a,k){ return {x:a.x*k, y:a.y*k}; }
function len(v){ return Math.hypot(v.x, v.y); }
function norm(v){
  const l = len(v) || 1;
  return {x:v.x/l, y:v.y/l};
}
function rotate(p, deg, cx, cy){
  const rad = deg * Math.PI / 180;
  const c = Math.cos(rad), s = Math.sin(rad);
  const x = p.x - cx, y = p.y - cy;
  return { x: cx + x*c - y*s, y: cy + x*s + y*c };
}
function reflectX(p, axisX){ return { x: axisX + (axisX - p.x), y: p.y }; }
function reflectY(p, axisY){ return { x: p.x, y: axisY + (axisY - p.y) }; }
function translatePts(pts, dx, dy){ return pts.map(p => ({x:p.x+dx, y:p.y+dy})); }
function centroid(pts){
  const s = pts.reduce((acc,p)=>({x:acc.x+p.x, y:acc.y+p.y}), {x:0,y:0});
  return {x:s.x/pts.length, y:s.y/pts.length};
}
function clampToBox(p, pad, W, H){
  return { x: clamp(p.x, pad, W-pad), y: clamp(p.y, pad, H-pad) };
}
function labelPos(pts, idx, W, H){
  const c = centroid(pts);
  const v = sub(pts[idx], c);
  const d = norm(v);
  const raw = add(pts[idx], mul(d, 20));
  return clampToBox(raw, 12, W, H);
}
function angleArcPath(pts, vIdx, adj1Idx, adj2Idx, r){
  const V = pts[vIdx];
  const A = pts[adj1Idx];
  const B = pts[adj2Idx];
  const v1 = norm(sub(A, V));
  const v2 = norm(sub(B, V));
  const p1 = add(V, mul(v1, r));
  const p2 = add(V, mul(v2, r));
  const cross = v1.x*v2.y - v1.y*v2.x;
  const sweep = cross >= 0 ? 1 : 0;
  return `M${p1.x.toFixed(1)} ${p1.y.toFixed(1)} A${r} ${r} 0 0 ${sweep} ${p2.x.toFixed(1)} ${p2.y.toFixed(1)}`;
}

function buildTriSvg(pts, labels, opts){
  const W = opts.W, H = opts.H;
  const strokeMain = "#111827";
  const edgeColor = opts.edgeColor || "#007bff";
  const angleColor = opts.angleColor || "#e91e63";
  const edge = opts.markEdge || [0,1];
  const vIdx = (opts.markVertex ?? 1);

  const path = `M${pts[0].x} ${pts[0].y} L${pts[1].x} ${pts[1].y} L${pts[2].x} ${pts[2].y} Z`;

  const pE1 = pts[edge[0]], pE2 = pts[edge[1]];
  const edgeLine = `M${pE1.x} ${pE1.y} L${pE2.x} ${pE2.y}`;

  const arc = angleArcPath(pts, vIdx, (vIdx+2)%3, (vIdx+1)%3, 30);

  const t0 = labelPos(pts, 0, W, H);
  const t1 = labelPos(pts, 1, W, H);
  const t2 = labelPos(pts, 2, W, H);

  return `
    <g stroke="${strokeMain}" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path d="${path}"/>
    </g>

    <g fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path d="${edgeLine}" stroke="${edgeColor}" stroke-width="12" opacity="0.95"/>
      <path d="${arc}" stroke="${angleColor}" stroke-width="10" opacity="0.95"/>
    </g>

    <g fill="#111827" font-family="Microsoft JhengHei" font-weight="900" font-size="28">
      <text x="${t0.x.toFixed(1)}" y="${t0.y.toFixed(1)}">${labels[0]}</text>
      <text x="${t1.x.toFixed(1)}" y="${t1.y.toFixed(1)}">${labels[1]}</text>
      <text x="${t2.x.toFixed(1)}" y="${t2.y.toFixed(1)}">${labels[2]}</text>
    </g>
  `;
}

function makeCongPairVariant(){
  const labelsLeft = choice([["A","B","C"],["P","Q","R"],["M","N","K"]]);
  const labelsRight = choice([["D","E","F"],["U","V","W"],["X","Y","Z"]]);
  const [A,B,C] = labelsLeft;
  const [D,E,F] = labelsRight;

  const map = { [A]:D, [B]:E, [C]:F };
  const variant = choice(["mirrorLR","flipUD","rotate180","stackTopBottom","rotate90"]);

  const W = 860, H = 360;

  const baseL = [pt(140, 270), pt(260, 110), pt(380, 270)];
  const cx = 260, cy = 190;

  let ptsL = baseL.slice();
  let ptsR = baseL.slice();

  if(variant === "mirrorLR"){
    ptsR = ptsR.map(p => reflectX(p, cx));
    ptsR = translatePts(ptsR, 340, 0);
  }

  if(variant === "flipUD"){
    ptsR = ptsR.map(p => reflectY(p, cy));
    ptsR = translatePts(ptsR, 340, 0);
  }

  if(variant === "rotate180"){
    ptsR = ptsR.map(p => rotate(p, 180, cx, cy));
    ptsR = translatePts(ptsR, 340, 0);
  }

  if(variant === "rotate90"){
    ptsR = ptsR.map(p => rotate(p, 90, cx, cy));
    ptsR = translatePts(ptsR, 360, 0);
  }

  if(variant === "stackTopBottom"){
    ptsL = [pt(260, 150), pt(350, 40), pt(440, 150)];
    const ccx = 350, ccy = 95;
    ptsR = ptsL.map(p => rotate(p, 180, ccx, ccy));
    ptsR = translatePts(ptsR, 0, 170);
  }

  const leftSvg = buildTriSvg(ptsL, [A,B,C], { W, H, markEdge:[0,1], markVertex:1, edgeColor:"#007bff", angleColor:"#e91e63" });
  const rightSvg = buildTriSvg(ptsR, [D,E,F], { W, H, markEdge:[0,1], markVertex:1, edgeColor:"#007bff", angleColor:"#e91e63" });

  const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
      <rect width="100%" height="100%" fill="#ffffff"/>
      ${leftSvg}
      ${rightSvg}
    </svg>
  `;

  return {
    img: svgToDataUri(svg),
    map,
    left: {A,B,C},
    right: {D,E,F},
    variant
  };
}

/* ========= ç„¡é™å‡ºé¡Œ ========= */
function pushRecent(sig){
  state.recentSig.unshift(sig);
  if(state.recentSig.length > 24) state.recentSig.pop();
}
function seenRecent(sig){ return state.recentSig.includes(sig); }

function makeQuestionLevel1(){
  const type = choice(["sum","maxAcute","equiAngle","isosBase","angleClass","thirdAngle","picClass","whichRight","whichObtuse","nameByAngles"]);
  if(type==="sum"){
    return { sig:"L1_sum", q:"ä¸‰è§’å½¢çš„ä¸‰å€‹å…§è§’ç›¸åŠ æ˜¯å¤šå°‘ï¼Ÿ",
      choices:["90Â°","180Â°","270Â°","360Â°"], a:1, explain:"ä»»ä½•ä¸‰è§’å½¢çš„ä¸‰å€‹å…§è§’ç›¸åŠ éƒ½æ˜¯ 180Â°ã€‚" };
  }
  if(type==="maxAcute"){
    return { sig:"L1_maxAcute", q:"ä¸€å€‹ä¸‰è§’å½¢ä¸­ï¼Œæœ€å¤šæœ‰å¹¾å€‹éŠ³è§’ï¼Ÿ",
      choices:["1 å€‹","2 å€‹","3 å€‹","4 å€‹"], a:2, explain:"ä¸‰è§’å½¢å…§è§’å’Œ 180Â°ï¼Œä¸‰å€‹è§’éƒ½å°æ–¼ 90Â° ä¹Ÿèƒ½æˆç«‹ï¼Œæ‰€ä»¥æœ€å¤š 3 å€‹ã€‚" };
  }
  if(type==="equiAngle"){
    return { sig:"L1_equiAngle", q:"æ­£ä¸‰è§’å½¢çš„ä¸‰å€‹è§’å„æ˜¯å¤šå°‘åº¦ï¼Ÿ",
      choices:["30Â°","45Â°","60Â°","90Â°"], a:2, explain:"æ­£ä¸‰è§’å½¢ä¸‰å€‹è§’ä¸€æ¨£å¤§ï¼Œ180Â° Ã· 3 = 60Â°ã€‚" };
  }
  if(type==="isosBase"){
    return { sig:"L1_isosBase", q:"ç­‰è…°ä¸‰è§’å½¢çš„å…©å€‹åº•è§’æœƒæ€æ¨£ï¼Ÿ",
      choices:["ä¸€å®šç›¸ç­‰","ä¸€å®šäº’è£œ","ä¸€å®šæ˜¯ç›´è§’","ä¸€å®šä¸åŒ"], a:0, explain:"ç­‰è…°ä¸‰è§’å½¢å…©è…°ç›¸ç­‰ï¼Œæ‰€ä»¥å…©å€‹åº•è§’ç›¸ç­‰ã€‚" };
  }
  if(type==="thirdAngle"){
    const base = randInt(30,80);
    const third = 180 - base - base;
    const opts = shuffle([third, third+10, third-10, third+20].map(x=>clamp(x,10,160)));
    return {
      sig:`L1_third_${base}`,
      q:`ç­‰è…°ä¸‰è§’å½¢çš„å…©å€‹åº•è§’éƒ½æ˜¯ ${base}Â°ï¼Œé ‚è§’æ˜¯å¤šå°‘åº¦ï¼Ÿ`,
      choices: opts.map(x=>`${x}Â°`),
      a: opts.indexOf(third),
      explain:`å…§è§’å’Œ 180Â°ï¼Œé ‚è§’ = 180Â° - ${base}Â° - ${base}Â° = ${third}Â°ã€‚`
    };
  }
  if(type==="angleClass"){
    const cat = choice(["acute","right","obtuse"]);
    let angles;
    if(cat==="acute"){
      const a = randInt(30,80), b = randInt(30,80), c = 180-a-b;
      if(!(c>0 && c<90)) return makeQuestionLevel1();
      angles = shuffle([a,b,c]);
    }else if(cat==="right"){
      const b = randInt(20,70), c = 90-b;
      angles = shuffle([90,b,c]);
    }else{
      const a = randInt(100,130), b = randInt(20,50), c = 180-a-b;
      if(!(c>0 && c<90)) return makeQuestionLevel1();
      angles = shuffle([a,b,c]);
    }
    const ans = cat==="acute" ? "éŠ³è§’ä¸‰è§’å½¢" : cat==="right" ? "ç›´è§’ä¸‰è§’å½¢" : "éˆè§’ä¸‰è§’å½¢";
    const choices = shuffle(["éŠ³è§’ä¸‰è§’å½¢","ç›´è§’ä¸‰è§’å½¢","éˆè§’ä¸‰è§’å½¢","ç„¡æ³•åˆ¤æ–·"]);
    return {
      sig:`L1_angleClass_${angles.join("_")}`,
      q:`ä¸€å€‹ä¸‰è§’å½¢çš„ä¸‰å€‹è§’æ˜¯ ${angles[0]}Â°ã€${angles[1]}Â°ã€${angles[2]}Â°ï¼Œé€™æ˜¯ä»€éº¼ä¸‰è§’å½¢ï¼Ÿ`,
      choices, a: choices.indexOf(ans),
      explain: ans==="éŠ³è§’ä¸‰è§’å½¢" ? "ä¸‰å€‹è§’éƒ½å°æ–¼ 90Â° â†’ éŠ³è§’ä¸‰è§’å½¢ã€‚"
            : ans==="ç›´è§’ä¸‰è§’å½¢" ? "æœ‰ä¸€å€‹è§’æ˜¯ 90Â° â†’ ç›´è§’ä¸‰è§’å½¢ã€‚"
            : "æœ‰ä¸€å€‹è§’å¤§æ–¼ 90Â° â†’ éˆè§’ä¸‰è§’å½¢ã€‚"
    };
  }
  if(type==="whichRight"){
    const options = ["90Â°ã€60Â°ã€30Â°","80Â°ã€70Â°ã€30Â°","100Â°ã€50Â°ã€30Â°","60Â°ã€60Â°ã€60Â°"];
    const ch = shuffle(options);
    return { sig:"L1_whichRight", q:"ä¸‹åˆ—å“ªä¸€çµ„è§’åº¦ä¸€å®šæ˜¯ã€Œç›´è§’ä¸‰è§’å½¢ã€ï¼Ÿ",
      choices: ch, a: ch.indexOf("90Â°ã€60Â°ã€30Â°"), explain:"æœ‰ä¸€å€‹è§’æ˜¯ 90Â° çš„ä¸‰è§’å½¢å°±æ˜¯ç›´è§’ä¸‰è§’å½¢ã€‚" };
  }
  if(type==="whichObtuse"){
    const options = ["110Â°ã€40Â°ã€30Â°","80Â°ã€60Â°ã€40Â°","90Â°ã€50Â°ã€40Â°","60Â°ã€60Â°ã€60Â°"];
    const ch = shuffle(options);
    return { sig:"L1_whichObtuse", q:"ä¸‹åˆ—å“ªä¸€çµ„è§’åº¦ä¸€å®šæ˜¯ã€Œéˆè§’ä¸‰è§’å½¢ã€ï¼Ÿ",
      choices: ch, a: ch.indexOf("110Â°ã€40Â°ã€30Â°"), explain:"æœ‰ä¸€å€‹è§’å¤§æ–¼ 90Â° å°±æ˜¯éˆè§’ä¸‰è§’å½¢ï¼›110Â° å°±æ˜¯éˆè§’ã€‚" };
  }
  if(type==="nameByAngles"){
    return { sig:"L1_nameByAngles", q:"å¦‚æœä¸€å€‹ä¸‰è§’å½¢æœ‰ä¸€å€‹è§’æ˜¯ 120Â°ï¼Œå®ƒä¸€å®šæ˜¯ï¼Ÿ",
      choices:["éŠ³è§’ä¸‰è§’å½¢","ç›´è§’ä¸‰è§’å½¢","éˆè§’ä¸‰è§’å½¢","æ­£ä¸‰è§’å½¢"], a:2, explain:"120Â° å¤§æ–¼ 90Â°ï¼Œæ‰€ä»¥æ˜¯éˆè§’ä¸‰è§’å½¢ã€‚" };
  }

  const picKind = choice(["right","isos","obtuse","equi"]);
  const img = picKind==="right" ? makeRightTri() : picKind==="isos" ? makeIsosTri() : picKind==="obtuse" ? makeObtuseTri() : makeEquiTri();
  const qChoices = ["æ­£ä¸‰è§’å½¢","ç­‰è…°ä¸‰è§’å½¢","ç›´è§’ä¸‰è§’å½¢","éˆè§’ä¸‰è§’å½¢"];
  const a = picKind==="equi" ? 0 : picKind==="isos" ? 1 : picKind==="right" ? 2 : 3;
  return {
    sig:`L1_pic_${picKind}`,
    q:"çœ‹åœ–ï¼šé€™å€‹ä¸‰è§’å½¢æœ€å¯èƒ½æ˜¯ï¼Ÿ",
    img,
    choices: qChoices,
    a,
    explain: picKind==="right" ? "åœ–ä¸­ç›´è§’å…©é‚Šä¸Šè‰² + ç›´è§’è¨˜è™Ÿ â†’ ç›´è§’ä¸‰è§’å½¢ã€‚"
          : picKind==="isos" ? "åœ–ä¸­å…©è…°æ•´æ®µä¸Šè‰² â†’ ç­‰è…°ä¸‰è§’å½¢ã€‚"
          : picKind==="equi" ? "ä¸‰é‚Šæ•´æ®µä¸Šè‰² â†’ æ­£ä¸‰è§’å½¢ã€‚"
          : "åœ–ä¸­æ©˜è‰²åœ“å¼§åŒ…ä½éˆè§’ â†’ éˆè§’ä¸‰è§’å½¢ã€‚"
  };
}

function makeQuestionLevel2(){
  const type = choice(["rightStep","isosStep","toolRight","toolAngleLen","checkRight","sumCheck","equiCond","isosRight","fixMistake"]);
  if(type==="rightStep"){
    return { sig:"L2_rightStep",
      q:"ã€Œå…ˆç”¨ä¸‰è§’æ¿æå‡ºç›´è§’å¾Œï¼Œå†ç”¨å°ºé€£æ¥å…©é‚Šã€‚ã€é€™æ¨£æœ€å¯èƒ½ç•«å‡ºï¼Ÿ",
      choices:["æ­£ä¸‰è§’å½¢","ç›´è§’ä¸‰è§’å½¢","éˆè§’ä¸‰è§’å½¢","ç­‰è…°ä¸‰è§’å½¢"],
      a:1, explain:"å…ˆæå‡ºç›´è§’å°±å›ºå®šæœ‰ 90Â°ï¼Œé€£æ¥å¾Œå¾—åˆ°ç›´è§’ä¸‰è§’å½¢ã€‚" };
  }
  if(type==="isosStep"){
    return { sig:"L2_isosStep",
      q:"è¦ç•«ã€Œç­‰è…°ä¸‰è§’å½¢ã€ï¼Œæ¯”è¼ƒåˆç†çš„åšæ³•æ˜¯ï¼Ÿ",
      choices:[
        "å…ˆç•«ä¸€æ¢é‚Šï¼Œå†ç•«å¦ä¸€æ¢è·Ÿå®ƒä¸€æ¨£é•·çš„é‚Šï¼Œæœ€å¾Œé€£æ¥å…©é‚Šç«¯é»",
        "å…ˆç•«ä¸‰æ¢é‚Šé•·éƒ½ä¸åŒçš„é‚Š",
        "å…ˆç•«ä¸€å€‹ç›´è§’ï¼Œå†ç•«ä¸‰å€‹ç›¸ç­‰è§’",
        "å…ˆç•«ä¸€å€‹åœ“ï¼Œå†éš¨ä¾¿é€£ä¸‰æ¢ç·š"
      ],
      a:0, explain:"ç­‰è…°çš„é—œéµæ˜¯å…©é‚Šç›¸ç­‰ï¼šå…ˆæŠŠå…©æ¢ç›¸åŒé•·åº¦çš„é‚Šç¢ºå®šä¸‹ä¾†æœ€ç©©ã€‚" };
  }
  if(type==="toolRight"){
    return { sig:"L2_toolRight",
      q:"ä½ æƒ³å¿«é€Ÿæª¢æŸ¥ã€Œæ˜¯ä¸æ˜¯ç›´è§’ã€ï¼Œæœ€æ–¹ä¾¿ç”¨ï¼Ÿ",
      choices:["é‡è§’å™¨","ä¸‰è§’æ¿ï¼ˆç›´è§’ï¼‰","æ©¡çš®æ“¦","è‰²ç´™"],
      a:1, explain:"ä¸‰è§’æ¿è‡ªå¸¶ 90Â°ï¼Œå°é½Šå°±èƒ½å¿«é€Ÿåˆ¤æ–·ã€‚" };
  }
  if(type==="toolAngleLen"){
    const ang = choice([60,80,100,120]);
    const len = randInt(3,8);
    return { sig:`L2_tool_${ang}_${len}`,
      q:`é¡Œç›®ï¼šç•«å‡ºä¸€å€‹è§’æ˜¯ ${ang}Â°ï¼Œä¸”æœ‰ä¸€æ¢é‚Šé•· ${len} å…¬åˆ†çš„ä¸‰è§’å½¢ã€‚æœ€éœ€è¦çš„å·¥å…·æ˜¯ï¼Ÿ`,
      choices:["é‡è§’å™¨èˆ‡ç›´å°º","åªè¦ç›´å°º","åªè¦é‡è§’å™¨","ä¸ç”¨å·¥å…·"],
      a:0, explain:"è¦é‡è§’ç”¨é‡è§’å™¨ï¼Œè¦ç•«æŒ‡å®šé•·åº¦ç”¨ç›´å°ºã€‚" };
  }
  if(type==="checkRight"){
    return { sig:"L2_checkRight",
      q:"è¦ç•«ã€Œç›´è§’ä¸‰è§’å½¢ã€ï¼Œæœ€é—œéµè¦å…ˆç¢ºå®šï¼Ÿ",
      choices:["ä¸€å€‹è§’æ˜¯ 90Â°","ä¸‰é‚Šéƒ½ç›¸ç­‰","å…©è§’æ˜¯ 60Â°","ä¸‰è§’å½¢é¢ç©"],
      a:0, explain:"ç›´è§’ä¸‰è§’å½¢çš„å®šç¾©å°±æ˜¯æœ‰ä¸€å€‹ 90Â°ã€‚" };
  }
  if(type==="sumCheck"){
    const wrongSum = choice([175,185,170,190]);
    return { sig:`L2_sum_${wrongSum}`,
      q:`ä½ ç•«å®Œä¸‰è§’å½¢å¾Œé‡è§’ï¼Œç™¼ç¾ä¸‰å…§è§’å’Œæ˜¯ ${wrongSum}Â°ï¼Œæœ€å¯èƒ½ä»£è¡¨ï¼Ÿ`,
      choices:["ä¸€å®šæ­£ç¢º","é‡è§’æˆ–ä½œåœ–æœ‰èª¤å·®","ä¸‰è§’å½¢å…§è§’å’Œä¸æ˜¯ 180Â°","å®ƒä¸æ˜¯ä¸‰è§’å½¢"],
      a:1, explain:"ç†è«–ä¸Šä¸‰è§’å½¢å…§è§’å’Œæ˜¯ 180Â°ï¼Œä¸ç­‰æ–¼ 180Â° é€šå¸¸æ˜¯é‡æ¸¬æˆ–ä½œåœ–èª¤å·®ã€‚" };
  }
  if(type==="equiCond"){
    return { sig:"L2_equiCond",
      q:"ä¸‹åˆ—å“ªå€‹æ¢ä»¶æœ€èƒ½ä¿è­‰ç•«å‡ºã€Œæ­£ä¸‰è§’å½¢ã€ï¼Ÿ",
      choices:["ä¸‰é‚Šä¸€æ¨£é•·","åªæœ‰ä¸€å€‹è§’ 60Â°","æœ‰ä¸€å€‹ç›´è§’","å…©è§’ç›¸ç­‰"],
      a:0, explain:"æ­£ä¸‰è§’å½¢çš„æ ¸å¿ƒæ¢ä»¶æ˜¯ä¸‰é‚Šç›¸ç­‰ï¼ˆä¹Ÿæœƒå¾—åˆ°ä¸‰è§’éƒ½æ˜¯ 60Â°ï¼‰ã€‚" };
  }
  if(type==="isosRight"){
    const s = randInt(3,7);
    return { sig:`L2_isosRight_${s}`,
      q:`æƒ³ç•«ã€Œç­‰è…°ç›´è§’ä¸‰è§’å½¢ï¼Œå…©è…° ${s} å…¬åˆ†ã€ï¼Œæœ€ç©©çš„åšæ³•æ˜¯ï¼Ÿ`,
      choices:[
        `å…ˆå›ºå®š 90Â°ï¼Œå†åœ¨å…©é‚Šå„é‡ ${s} å…¬åˆ†ï¼Œæœ€å¾Œé€£ç·š`,
        "å…ˆç•« 60Â° å†éš¨ä¾¿é€£ç·š",
        "å…ˆç•«ä¸‰é‚Šéƒ½ä¸€æ¨£é•·",
        "ç•«å®Œå†æƒ³è¾¦æ³•è®Šæˆç›´è§’"
      ],
      a:0, explain:"ç­‰è…°ç›´è§’ï¼ä¸€å€‹ç›´è§’ï¼‹å…©è…°ç›¸ç­‰ï¼›å…ˆå›ºå®š 90Â° å†é‡é•·åº¦æœ€æº–ã€‚" };
  }
  return {
    sig:"L2_fixMistake",
    q:"ä½ ç•«å®Œå¾Œç™¼ç¾è§’åº¦åä¸€é»é»ï¼Œæœ€åˆç†çš„åšæ³•æ˜¯ï¼Ÿ",
    choices:["ç”¨é‡è§’å™¨å†å°ä¸€æ¬¡ä¸¦å¾®èª¿","ç›´æ¥èªªæ²’å·®","æŠŠä¸‰è§’å½¢æ•´å€‹æ’•æ‰","æŠŠè§’åº¦æ”¹å¯«æˆæƒ³è¦çš„"],
    a:0,
    explain:"ç”¨å·¥å…·æª¢æŸ¥å†å¾®èª¿ï¼Œæ‰æ˜¯æœ€ç©©çš„ä¿®æ­£æ–¹å¼ã€‚"
  };
}

function makeQuestionLevel3(){
  const type = choice(["def","move","must","point","angle","seg","true","swap"]);
  if(type==="def"){
    return { sig:"L3_def",
      q:"å…©å€‹åœ–å½¢é€éç§»å‹•æˆ–ç¿»è½‰å¾Œå¯ä»¥å®Œå…¨ç–Šåˆï¼Œç¨±ç‚ºï¼Ÿ",
      choices:["ç›¸ä¼¼","å…¨ç­‰","å¹³è¡Œ","å‚ç›´"],
      a:1, explain:"èƒ½å®Œå…¨é‡åˆï¼ˆå¤§å°ã€å½¢ç‹€éƒ½ä¸€æ¨£ï¼‰â†’ å…¨ç­‰ã€‚" };
  }
  if(type==="move"){
    return { sig:"L3_move",
      q:"å…¨ç­‰åœ–å½¢å¯ä»¥é å“ªäº›å‹•ä½œç–Šåˆï¼Ÿ",
      choices:["æ”¾å¤§æˆ–ç¸®å°","å¹³ç§»ã€æ—‹è½‰ã€ç¿»è½‰","æ”¹é¡è‰²","æ”¹æè³ª"],
      a:1, explain:"å…¨ç­‰å…è¨±å¹³ç§»/æ—‹è½‰/ç¿»è½‰ï¼›æ”¾å¤§ç¸®å°æœƒæ”¹å¤§å°å°±ä¸æ˜¯å…¨ç­‰ã€‚" };
  }
  if(type==="must"){
    return { sig:"L3_must",
      q:"å¦‚æœå…©å€‹ä¸‰è§’å½¢å…¨ç­‰ï¼Œä¸‹åˆ—ä½•è€…ä¸€å®šæ­£ç¢ºï¼Ÿ",
      choices:["å°æ‡‰é‚Šé•·ç›¸ç­‰","å…¶ä¸­ä¸€å€‹ä¸€å®šæ˜¯æ­£ä¸‰è§’å½¢","ä¸€å®šéƒ½æœ‰ç›´è§’","é¢ç©ä¸ä¸€å®šç›¸ç­‰"],
      a:0, explain:"å…¨ç­‰ï¼å°æ‡‰é‚Šã€å°æ‡‰è§’éƒ½ç›¸ç­‰ï¼Œæ‰€ä»¥å°æ‡‰é‚Šé•·ä¸€å®šç›¸ç­‰ã€‚" };
  }

  const pair = makeCongPairVariant();
  const {A,B,C} = pair.left;
  const {D,E,F} = pair.right;

  const leftPick = choice([A,B,C]);
  const rightCorrect = pair.map[leftPick];

  if(type==="point"){
    const opts = shuffle([`é» ${D}`,`é» ${E}`,`é» ${F}`]);
    return {
      sig:`L3_point_${pair.variant}_${leftPick}`,
      q:`çœ‹åœ–ï¼šå…©å€‹ä¸‰è§’å½¢å…¨ç­‰ï¼ˆå¯æ—‹è½‰/ç¿»è½‰ï¼‰ã€‚è‹¥é» ${leftPick} çš„å°æ‡‰é»æ˜¯ï¼Ÿ`,
      img: pair.img,
      choices: opts,
      a: opts.indexOf(`é» ${rightCorrect}`),
      explain:`å°æ‡‰æ˜¯ä¸€å°ä¸€ï¼š${leftPick} â†” ${rightCorrect}ã€‚`
    };
  }

  if(type==="angle"){
    const opts = shuffle([`âˆ ${D}`,`âˆ ${E}`,`âˆ ${F}`]);
    return {
      sig:`L3_angle_${pair.variant}_${leftPick}`,
      q:`çœ‹åœ–ï¼šè‹¥ âˆ ${leftPick} çš„å°æ‡‰è§’æ˜¯ï¼Ÿ`,
      img: pair.img,
      choices: opts,
      a: opts.indexOf(`âˆ ${rightCorrect}`),
      explain:`å…¨ç­‰çš„å°æ‡‰è§’ç›¸ç­‰ï¼šâˆ ${leftPick} â†” âˆ ${rightCorrect}ã€‚`
    };
  }

  if(type==="seg"){
    const segs = [[A,B],[B,C],[A,C]];
    const pick = choice(segs);
    const sLeft = pick.join("");
    const sRight = pair.map[pick[0]] + pair.map[pick[1]];
    const cand = shuffle([seg(D+E), seg(E+F), seg(D+F)]);
    const correctText = seg(sRight);
    let choices = cand;
    if(!choices.includes(correctText)) choices[0] = correctText;
    return {
      sig:`L3_seg_${pair.variant}_${sLeft}`,
      q:`çœ‹åœ–ï¼šè‹¥ ${seg(sLeft)} çš„å°æ‡‰é‚Šæ˜¯ï¼Ÿ`,
      img: pair.img,
      choices,
      a: choices.indexOf(correctText),
      explain:`ç«¯é»è¦ä¸€ä¸€å°æ‡‰ï¼Œæ‰€ä»¥ ${seg(sLeft)} â†” ${seg(sRight)}ã€‚`
    };
  }

  if(type==="true"){
    const correct = "å°æ‡‰é‚Šä¸€æ¨£é•·";
    const opts = shuffle([correct,"é¡è‰²ä¸€æ¨£æ‰ç®—å…¨ç­‰","æ–¹å‘ä¸€å®šè¦ç›¸åŒæ‰ç®—å…¨ç­‰","ä¸€å®šéƒ½æœ‰ç›´è§’æ‰ç®—å…¨ç­‰"]);
    return {
      sig:`L3_true_${pair.variant}`,
      q:"çœ‹åœ–ï¼šå…©å€‹ä¸‰è§’å½¢å…¨ç­‰ã€‚ä¸‹åˆ—å“ªå€‹æ•˜è¿°ä¸€å®šæ­£ç¢ºï¼Ÿ",
      img: pair.img,
      choices: opts,
      a: opts.indexOf(correct),
      explain:"å…¨ç­‰ä»£è¡¨å¤§å°èˆ‡å½¢ç‹€ç›¸åŒï¼Œæ‰€ä»¥å°æ‡‰é‚Šé•·ä¸€å®šç›¸ç­‰ã€‚"
    };
  }

  const givenRight = choice([D,E,F]);
  const inverseMap = {}; inverseMap[D]=A; inverseMap[E]=B; inverseMap[F]=C;
  const correctLeft = inverseMap[givenRight];
  const opts = shuffle([`é» ${A}`,`é» ${B}`,`é» ${C}`]);
  return {
    sig:`L3_swap_${pair.variant}_${givenRight}`,
    q:`çœ‹åœ–ï¼šå…©å€‹ä¸‰è§’å½¢å…¨ç­‰ã€‚è‹¥é» ${givenRight} çš„å°æ‡‰é»åœ¨å·¦é‚Šï¼Œæ˜¯å“ªä¸€é»ï¼Ÿ`,
    img: pair.img,
    choices: opts,
    a: opts.indexOf(`é» ${correctLeft}`),
    explain:`å°æ‡‰æ˜¯ä¸€å°ä¸€ï¼š${givenRight} â†” ${correctLeft}ã€‚`
  };
}

function nextRandomQuestion(level){
  for(let t=0;t<40;t++){
    const q = (level===1) ? makeQuestionLevel1() : (level===2) ? makeQuestionLevel2() : makeQuestionLevel3();
    if(!seenRecent(q.sig)){
      pushRecent(q.sig);
      return q;
    }
  }
  const q = (level===1) ? makeQuestionLevel1() : (level===2) ? makeQuestionLevel2() : makeQuestionLevel3();
  pushRecent(q.sig);
  return q;
}

/* ======== æš«åœ ======== */
function togglePause(on){
  if(!document.getElementById("game-page").classList.contains("active-page")) return;
  state.paused = !!on;
  const overlay = $("#pause-overlay");
  overlay.style.display = state.paused ? "flex" : "none";
  overlay.setAttribute("aria-hidden", state.paused ? "false" : "true");
  if(state.paused){
    clearTimeout(state.autoNext);
    state.autoNext = null;
  }
  setTimeout(renderMath, 0);
}

/* ======== è¨ˆæ™‚ ======== */
function startTimer(){
  stopTimer();
  state.tick = setInterval(() => {
    if(state.paused) return;
    state.timer -= 1;
    $("#timer").innerText = state.timer;
    if(state.timer <= 0){
      state.timer = 0;
      $("#timer").innerText = 0;
      stopTimer();
      endLevel("æ™‚é–“åˆ°ï¼ä½ æŠŠé€Ÿåº¦ç‡ƒæˆäº†æ˜Ÿå¡µï¼Œä½†ç†è§£é‚„åœ¨ç™¼å…‰ã€‚");
    }
  }, 1000);
}
function stopTimer(){
  if(state.tick){
    clearInterval(state.tick);
    state.tick = null;
  }
}

/* ======== é€²å…¥é—œå¡ ======== */
function startLevel(level){
  state.level = level;
  state.speed = $("#speed-select").value || "normal";
  const conf = SPEED[state.speed] || SPEED.normal;

  state.score = 0;
  state.streak = 0;
  state.answered = false;
  state.timer = conf.time;
  state.paused = false;
  state.qNo = 1;
  state.recentSig = [];
  state.currentQ = null;

  clearTimeout(state.autoNext);
  state.autoNext = null;

  $("#current-level-name").innerText = LEVEL_NAME[level];
  $("#score").innerText = state.score;
  $("#timer").innerText = state.timer;
  $("#q-progress").innerText = `ç¬¬ ${state.qNo} é¡Œ`;
  $("#mode-badge").innerText = `æ¨¡å¼ï¼š${conf.label}`;
  $("#streak-badge").innerText = `é€£å°ï¼š${state.streak}`;
  $("#feedback").className = "feedback";
  $("#feedback").style.display = "none";
  $("#next-btn").style.display = "none";
  togglePause(false);

  switchPage("game-page");
  startTimer();
  renderQuestion();
}

/* ======== å‡ºé¡Œ ======== */
function renderQuestion(){
  state.answered = false;
  $("#next-btn").style.display = "none";
  $("#feedback").style.display = "none";
  $("#feedback").className = "feedback";

  let q = nextRandomQuestion(state.level);
  q = ensureUniqueChoices(q);
  state.currentQ = q;

  $("#q-progress").innerText = `ç¬¬ ${state.qNo} é¡Œ`;

  const letters = ["A","B","C","D"].slice(0, q.choices.length);

  const figureHtml = q.img
    ? `<div class="q-figure"><img src="${q.img}" alt="é¡Œç›®åœ–å½¢"></div>`
    : "";

  const content = `
    <div class="q-title">Q${state.qNo}. ${q.q}</div>
    ${figureHtml}
    <div class="choices">
      ${q.choices.map((c,i)=>`
        <button class="choice-btn" onclick="answer(${i})">
          <div class="choice-key">${letters[i]}</div>
          <div>${c}</div>
        </button>
      `).join("")}
    </div>
  `;
  $("#game-content").innerHTML = content;
  setTimeout(renderMath, 0);
}

/* ======== ä½œç­” ======== */
function answer(choiceIdx){
  if(state.answered || state.paused) return;
  state.answered = true;

  const conf = SPEED[state.speed] || SPEED.normal;
  const q = state.currentQ;

  const timeLeft = state.timer;
  const base = 100;
  const speedBonus = Math.round((timeLeft/ conf.time) * 40 * conf.mult);
  const streakBonus = Math.min(60, state.streak * 10);

  if(choiceIdx === q.a){
    state.streak += 1;
    const gain = Math.round((base + speedBonus + streakBonus) * conf.mult);
    state.score += gain;

    $("#score").innerText = state.score;
    $("#streak-badge").innerText = `é€£å°ï¼š${state.streak}`;

    showFeedback(true,
      `âœ… ç­”å°ï¼+${gain} åˆ†<br><span style="font-weight:800;opacity:.9;">${q.explain}</span>`
    );
  }else{
    state.streak = 0;
    $("#streak-badge").innerText = `é€£å°ï¼š0`;

    state.score = Math.max(0, state.score - conf.wrongScore);
    state.timer = clamp(state.timer - conf.wrongPenalty, 0, 999);

    $("#score").innerText = state.score;
    $("#timer").innerText = state.timer;

    const correctLetter = ["A","B","C","D"][q.a];
    const correctText = q.choices[q.a];

    showFeedback(false,
      `âŒ å·®ä¸€é»é»ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯ <b>${correctLetter}</b>ï¼š<b>${correctText}</b><br>
       <span style="font-weight:800;opacity:.9;">${q.explain}</span><br>
       <span style="opacity:.9;">æ‰£ ${conf.wrongScore} åˆ†ã€æ‰£ ${conf.wrongPenalty} ç§’ï¼ˆåˆ¥æ€¥ï¼Œä½ æ­£åœ¨è®Šå¼·ã€‚ï¼‰</span>`
    );
  }

  setTimeout(renderMath, 0);

  clearTimeout(state.autoNext);
  $("#next-btn").style.display = "inline-flex";
  state.autoNext = setTimeout(() => {
    if(state.paused) return;
    nextQuestion(true);
  }, 1300);
}

function showFeedback(ok, html){
  const fb = $("#feedback");
  fb.style.display = "block";
  fb.className = ok ? "feedback ok" : "feedback bad";
  fb.innerHTML = html;
}

function nextQuestion(fromAuto=false){
  if(!state.answered || state.paused) return;

  clearTimeout(state.autoNext);
  state.autoNext = null;

  state.qNo += 1;
  renderQuestion();

  if(!fromAuto){
    $("#next-btn").style.display = "none";
  }
}

function endLevel(message){
  stopTimer();
  clearTimeout(state.autoNext);
  state.autoNext = null;

  const conf = SPEED[state.speed] || SPEED.normal;
  const timeBonus = Math.round(state.timer * 2 * conf.mult);
  state.score += timeBonus;

  upsertLevelScore(state.playerName, state.level, state.score);

  const content = `
    <div style="text-align:center;">
      <h2 style="margin:6px 0 4px;">ğŸ‰ ${escapeHtml(message)}</h2>
      <div class="sub">ä½ ä¸æ˜¯åœ¨åšé¡Œç›®ï¼Œä½ æ˜¯åœ¨æŠŠç†è§£ï¼Œé»äº®ã€‚</div>

      <div class="pill-row" style="margin-top:14px;">
        <div class="pill"><i class="fa-solid fa-star"></i>æœ¬é—œå¾—åˆ†ï¼š${state.score}</div>
        <div class="pill"><i class="fa-solid fa-hourglass-end"></i>æ™‚é–“çå‹µï¼š+${timeBonus}</div>
        <div class="pill"><i class="fa-solid fa-flag-checkered"></i>ä½œç­”é¡Œè™Ÿï¼šåˆ°ç¬¬ ${state.qNo} é¡Œ</div>
      </div>

      <div style="margin-top:18px;max-width:720px;margin-left:auto;margin-right:auto;opacity:.92;font-weight:800;line-height:1.7;">
        ä½ æ¯ç­”ä¸€é¡Œï¼Œéƒ½åœ¨æ›¿å¤§è…¦é‹ªä¸€æ¢æ›´é †çš„è·¯ï¼›ä¸‹ä¸€æ¬¡ï¼Œæœƒæ›´å¿«ã€æ›´æº–ã€æ›´å¸¥ã€‚
      </div>

      <div class="controls-row" style="justify-content:center;margin-top:18px;">
        <button class="btn btn-primary" onclick="backToLobby()"><i class="fa-solid fa-door-open"></i>å›åˆ°é—œå¡é¸æ“‡</button>
        <button class="btn btn-ghost" onclick="restartLevel()"><i class="fa-solid fa-rotate-right"></i>å†æŒ‘æˆ°ä¸€æ¬¡</button>
      </div>
    </div>
  `;

  $("#game-content").innerHTML = content;
  $("#feedback").style.display = "none";
  $("#next-btn").style.display = "none";
  togglePause(false);
  setTimeout(renderMath, 0);
}

function backToLobby(){
  stopTimer();
  clearTimeout(state.autoNext);
  state.autoNext = null;
  togglePause(false);
  renderLeaderboard();
  switchPage("lobby-page");
}
function restartLevel(){
  togglePause(false);
  startLevel(state.level);
}
function restartConfirm(){
  if(!document.getElementById("game-page").classList.contains("active-page")) return;
  const ok = confirm("è¦é‡ä¾†æœ¬é—œå—ï¼Ÿï¼ˆé¡Œç›®æœƒé‡æ–°éš¨æ©Ÿã€åˆ†æ•¸é‡æ–°è¨ˆç®—ï¼‰");
  if(ok) restartLevel();
}

renderLeaderboard();
setTimeout(renderMath, 0);
</script>

</body>
</html>





