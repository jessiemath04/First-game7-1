<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Jessie Mathï½œä¸‰è§’å½¢èˆ‡å…¨ç­‰é€²éš</title>

  <!-- Icon / Font -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0f172a;
      --muted:#6b7280;
      --line:#e5e7eb;
      --bg:#f4f6fb;
      --card:#ffffff;
      --shadow:0 12px 35px rgba(15,23,42,.10);
      --radius-lg:22px;
      --radius-md:16px;
      --brand:#5f73ff;
      --brand2:#f7b3c2;
      --accent:#FFD700;
      --good:#16a34a;
      --bad:#dc2626;
      --warning:#fb923c;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Noto Sans TC',system-ui,-apple-system, BlinkMacSystemFont,'Segoe UI',sans-serif;
      background:radial-gradient(circle at top,#e0e7ff 0,transparent 55%), #f3f4f6;
      color:var(--ink);
      min-height:100vh;
    }

    img{max-width:100%;display:block}

    .app-shell{
      max-width:1100px;
      margin:0 auto;
      padding:12px 12px 32px;
    }

    /* --- Hero / Topbar --- */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 16px;
      margin-bottom:14px;
      background:#ffffffd9;
      backdrop-filter:blur(12px);
      border-radius:999px;
      box-shadow:0 10px 30px rgba(15,23,42,.10);
      border:1px solid rgba(148,163,184,.35);
      position:sticky;
      top:8px;
      z-index:30;
    }

    .brand-left{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .brand-avatar{
      width:42px;
      height:42px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 20%,#fff7cc,#ffd54a);
      padding:3px;
      box-shadow:0 0 0 3px rgba(253,224,71,.7);
      flex-shrink:0;
    }

    .brand-avatar img{
      width:100%;
      height:100%;
      border-radius:50%;
      object-fit:contain;
      background:transparent;
    }

    .brand-text-main{
      font-family:'Fredoka',system-ui;
      font-size:1.1rem;
      letter-spacing:.03em;
      color:var(--ink);
      line-height:1.1;
    }
    .brand-text-main span{
      color:var(--brand);
      font-weight:700;
    }
    .brand-text-sub{
      font-size:.78rem;
      color:var(--muted);
      margin-top:2px;
    }

    .nav-right{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .nav-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(248,250,252,.9);
      font-size:.8rem;
      color:var(--ink);
      text-decoration:none;
      transition:.2s;
      white-space:nowrap;
    }
    .nav-chip i{
      font-size:.9rem;
    }
    .nav-chip:hover{
      background:#eef2ff;
      border-color:var(--brand);
      transform:translateY(-1px);
      box-shadow:0 8px 18px rgba(79,70,229,.18);
    }
    .nav-chip.main{
      background:linear-gradient(135deg,#4f46e5,#6366f1);
      color:#fff;
      border:none;
      box-shadow:0 10px 25px rgba(79,70,229,.28);
    }
    .nav-chip.main:hover{
      filter:brightness(1.05);
      transform:translateY(-1px);
    }

    /* Layout / Cards */
    .layout-main{
      margin-top:16px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow);
      padding:18px 18px 20px;
      border:1px solid rgba(148,163,184,.25);
    }

    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }
    .card-title{
      font-size:1.1rem;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:6px;
      color:var(--ink);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:.7rem;
      background:rgba(96,165,250,.12);
      color:#1d4ed8;
      border:1px solid rgba(129,140,248,.35);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 9px;
      border-radius:999px;
      background:#f3f4ff;
      font-size:.75rem;
      color:#4c51bf;
    }

    .pill i{font-size:.8rem;}

    .card-body{
      font-size:.9rem;
      color:var(--ink);
    }

    .input-row{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:10px;
    }

    .input-row label{
      font-size:.85rem;
      font-weight:600;
      color:var(--muted);
    }

    .text-input{
      width:100%;
      border-radius:999px;
      border:1px solid var(--line);
      padding:9px 14px;
      font-size:.9rem;
      outline:none;
      transition:.18s;
      background:#f9fafb;
    }
    .text-input:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(99,102,241,.4);
      background:#ffffff;
    }

    .btn{
      border:none;
      outline:none;
      cursor:pointer;
      border-radius:999px;
      padding:9px 16px;
      font-size:.9rem;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:.18s;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(135deg,#4f46e5,#6366f1);
      color:#fff;
      box-shadow:0 12px 25px rgba(79,70,229,.35);
    }
    .btn-primary:disabled{
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
    }
    .btn-primary:not(:disabled):hover{
      filter:brightness(1.06);
      transform:translateY(-1px);
    }
    .btn-ghost{
      background:#f4f4ff;
      color:#4338ca;
    }
    .btn-ghost:hover{
      background:#e0e7ff;
      transform:translateY(-1px);
    }
    .btn-danger{
      background:#fee2e2;
      color:#b91c1c;
    }
    .btn-danger:hover{
      background:#fecaca;
      transform:translateY(-1px);
    }

    .btn-sm{
      padding:6px 10px;
      font-size:.8rem;
    }

    .btn-pill-toggle{
      padding:7px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#f9fafb;
      font-size:.8rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.16s;
    }
    .btn-pill-toggle i{font-size:.75rem;}
    .btn-pill-toggle.active{
      background:#eef2ff;
      border-color:#4f46e5;
      color:#312e81;
      box-shadow:0 8px 18px rgba(79,70,229,.25);
    }

    .btn-full{
      width:100%;
      justify-content:center;
    }

    .stack-vertical{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .two-column{
      display:grid;
      grid-template-columns:minmax(0,2.2fr) minmax(0,1.4fr);
      gap:14px;
      margin-top:10px;
    }

    /* Bullets / Info */
    .bullet-list{
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.85rem;
      color:var(--muted);
      margin-top:4px;
    }
    .bullet-list li{
      display:flex;
      align-items:flex-start;
      gap:5px;
    }
    .bullet-dot{
      width:5px;
      height:5px;
      border-radius:999px;
      margin-top:6px;
      background:#a855f7;
      flex-shrink:0;
    }

    .chips-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .chip{
      font-size:.75rem;
      padding:3px 8px;
      border-radius:999px;
      background:#f3f4ff;
      color:#4c51bf;
    }

    .hint-text{
      font-size:.8rem;
      color:var(--muted);
      margin-top:6px;
    }

    /* Screens */
    .screen{display:none;}
    .screen.active{display:block;}

    /* Menu screen */
    .menu-grid{
      display:grid;
      grid-template-columns:minmax(0,1.2fr) minmax(0,1.5fr);
      gap:14px;
      margin-top:12px;
    }

    .section-title{
      font-size:.9rem;
      font-weight:700;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .section-title i{font-size:.9rem;color:#4f46e5;}

    .level-buttons,.difficulty-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
    }

    /* Game screen */
    .game-top{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }

    .status-item{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.82rem;
      color:var(--muted);
    }
    .status-label{
      font-weight:600;
      color:#4b5563;
    }

    .timer-wrap{
      flex:1;
      min-width:160px;
    }
    .timer-bar-bg{
      width:100%;
      height:10px;
      border-radius:999px;
      background:#e5e7eb;
      overflow:hidden;
      position:relative;
    }
    .timer-bar-fill{
      height:100%;
      width:100%;
      border-radius:999px;
      background:linear-gradient(90deg,#22c55e,#eab308,#ef4444);
      transform-origin:left center;
      transition:width .25s ease;
    }
    .timer-text{
      font-size:.75rem;
      color:var(--muted);
      margin-top:2px;
      display:flex;
      justify-content:space-between;
    }

    .game-main{
      display:grid;
      grid-template-columns:minmax(0,2.2fr) minmax(0,1.4fr);
      gap:12px;
      margin-top:5px;
      position:relative;
    }

    .question-card,.story-card{
      background:#f9fafb;
      border-radius:var(--radius-md);
      border:1px solid var(--line);
      padding:12px 12px 12px;
      position:relative;
      overflow:hidden;
    }

    .question-title{
      font-size:.9rem;
      font-weight:700;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .question-title span.flag{
      font-size:.72rem;
      padding:2px 8px;
      border-radius:999px;
      background:#eef2ff;
      color:#4338ca;
    }

    .question-text{
      font-size:.94rem;
      line-height:1.5;
      margin-bottom:8px;
    }

    .options-grid{
      display:flex;
      flex-direction:column;
      gap:7px;
      margin-top:4px;
    }

    .option-btn{
      width:100%;
      border-radius:999px;
      border:1px solid var(--line);
      padding:7px 12px;
      font-size:.88rem;
      text-align:left;
      cursor:pointer;
      background:#ffffff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      transition:.15s;
    }
    .option-main{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .choice-tag{
      width:20px;
      height:20px;
      border-radius:999px;
      border:1px solid #c4b5fd;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.8rem;
      color:#4c1d95;
      background:#f5f3ff;
      flex-shrink:0;
    }

    .option-btn:hover{
      border-color:#4f46e5;
      box-shadow:0 7px 16px rgba(79,70,229,.18);
      transform:translateY(-1px);
    }
    .option-btn.correct{
      border-color:var(--good);
      background:#dcfce7;
    }
    .option-btn.wrong{
      border-color:var(--bad);
      background:#fee2e2;
    }
    .option-btn.disabled{
      opacity:.6;
      pointer-events:none;
    }

    .feedback{
      margin-top:4px;
      font-size:.8rem;
      min-height:18px;
    }
    .feedback.good{color:var(--good);}
    .feedback.bad{color:var(--bad);}

    /* ğŸ”» æƒ…å¢ƒæ’åœ–å¡æ•´å€éš±è—ï¼ˆä¾ä½ çš„è¦æ±‚åˆªæ‰é€™å€çš„å‘ˆç¾ï¼‰ */
    .story-card{
      display:none;
    }

    .game-actions{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .game-actions .btn{
      flex:1 1 90px;
      justify-content:center;
    }

    .btn-warning{
      background:#fef3c7;
      color:#92400e;
    }
    .btn-warning:hover{
      background:#fde68a;
      transform:translateY(-1px);
    }

    /* Pause overlay */
    .pause-overlay{
      position:absolute;
      inset:0;
      background:rgba(15,23,42,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:15;
      backdrop-filter:blur(4px);
      border-radius:var(--radius-md);
      display:none;
    }
    .pause-box{
      background:#0b1120;
      color:#e5e7eb;
      padding:18px 18px 16px;
      border-radius:18px;
      box-shadow:0 18px 40px rgba(15,23,42,.85);
      text-align:center;
      max-width:260px;
    }
    .pause-box h3{
      font-size:1rem;
      margin-bottom:6px;
    }
    .pause-box p{
      font-size:.82rem;
      color:#cbd5f5;
    }

    /* Leaderboard */
    .leaderboard-card{
      background:#f9fafb;
      border-radius:var(--radius-md);
      border:1px solid var(--line);
      padding:10px 10px 10px;
      max-height:280px;
      overflow:auto;
      font-size:.78rem;
    }

    .leader-row{
      display:grid;
      grid-template-columns:1.1fr .6fr .6fr .6fr;
      gap:6px;
      padding:4px 4px;
      border-radius:10px;
      align-items:center;
    }
    .leader-row.header{
      font-weight:700;
      color:#4b5563;
      position:sticky;
      top:0;
      background:#f3f4ff;
      z-index:2;
    }
    .leader-row:not(.header):nth-child(odd){
      background:#fefce8;
    }
    .leader-row:not(.header):nth-child(even){
      background:#f9fafb;
    }

    .star-display{
      color:#facc15;
      font-size:.8rem;
    }

    /* Result Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
      padding:14px;
    }
    .modal-backdrop.active{display:flex;}

    .modal-panel{
      max-width:380px;
      width:100%;
      background:#0f172a;
      color:#e5e7eb;
      border-radius:24px;
      box-shadow:0 25px 60px rgba(15,23,42,.9);
      padding:18px 18px 16px;
      position:relative;
    }
    .modal-panel::before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:26px;
      padding:1px;
      background:conic-gradient(from 160deg,#4f46e5,#f97316,#22c55e,#4f46e5);
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;
              mask-composite:exclude;
      opacity:.7;
    }

    .modal-inner{
      position:relative;
      z-index:1;
    }

    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .modal-title{
      font-size:1rem;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .modal-title span.icon{
      width:28px;
      height:28px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#1e293b;
      color:#facc15;
    }

    .modal-close{
      border:none;
      background:transparent;
      color:#9ca3af;
      cursor:pointer;
      padding:4px;
    }
    .modal-close:hover{
      color:#e5e7eb;
    }

    .result-main{
      margin-top:4px;
      font-size:.86rem;
    }
    .result-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:2px 0;
    }
    .result-label{
      color:#9ca3af;
    }
    .result-value{
      font-weight:600;
    }

    .big-stars{
      font-size:1.3rem;
      margin:6px 0 4px;
      color:#facc15;
      display:flex;
      align-items:center;
      gap:4px;
    }

    .modal-actions{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .btn-outline{
      background:transparent;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      color:#e5e7eb;
      padding:8px 12px;
      font-size:.82rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      flex:1 1 100px;
      justify-content:center;
      transition:.16s;
    }
    .btn-outline:hover{
      background:#020617;
      border-color:#e5e7eb;
    }

    .btn-save{
      background:#22c55e;
      color:#052e16;
      border:none;
      font-weight:700;
      box-shadow:0 10px 25px rgba(34,197,94,.45);
    }
    .btn-save:disabled{
      opacity:.5;
      cursor:default;
      box-shadow:none;
    }

    .modal-note{
      font-size:.76rem;
      color:#9ca3af;
      margin-top:4px;
    }

    /* Utility */
    .hidden{display:none!important;}

    @media (max-width:900px){
      .topbar{
        border-radius:18px;
      }
      .two-column,
      .menu-grid,
      .game-main{
        grid-template-columns:minmax(0,1fr);
      }
      .game-actions .btn{
        flex:1 1 calc(33.33% - 8px);
      }
    }

    @media (max-width:640px){
      .app-shell{
        padding:10px 10px 26px;
      }
      .topbar{
        flex-direction:column;
        align-items:flex-start;
        gap:8px;
      }
      .nav-right{
        justify-content:flex-start;
      }
      .card{
        padding:15px 14px 16px;
      }
      .game-actions .btn{
        flex:1 1 100%;
      }
      .leader-row{
        grid-template-columns:1.4fr .7fr .7fr .7fr;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <!-- Hero / Topbar -->
  <header class="topbar">
    <div class="brand-left">
      <div class="brand-avatar">
        <!-- è«‹æ”¾åŒè³‡æ–™å¤¾çš„ JESSIEMATH-Q.pngï¼Œåº•è‰²éœ€é€æ˜ -->
        <img src="JESSIEMATH-Q.png" alt="Jessie Math å“ç‰Œé ­åƒ">
      </div>
      <div>
        <div class="brand-text-main"><span>Jessie Math</span> ï½œä¸‰è§’å½¢å†’éšª</div>
        <div class="brand-text-sub">å››å¹´ç´š ä¸‰è§’å½¢èˆ‡å…¨ç­‰äº’å‹•éŠæˆ²</div>
      </div>
    </div>
    <nav class="nav-right">
      <a class="nav-chip" href="https://jessiemath0703-chu.github.io/website2/" target="_blank" rel="noopener">
        <i class="fa-solid fa-house"></i>
        <span>é¦–é </span>
      </a>
      <a class="nav-chip" href="https://jessiemath0703-chu.github.io/Game-Lobby/" target="_blank" rel="noopener">
        <i class="fa-solid fa-gamepad"></i>
        <span>éŠæˆ²å¤§å»³</span>
      </a>
      <a class="nav-chip main" href="https://jessiemath0703-chu.github.io/Game-Lobby/#g4-u7" target="_blank" rel="noopener">
        <i class="fa-solid fa-angles-left"></i>
        <span>å››å¹´ç´šä¸‰è§’å½¢èˆ‡å…¨ç­‰</span>
      </a>
    </nav>
  </header>

  <main class="layout-main">
    <!-- Screen 1ï¼šè¼¸å…¥åå­—ï¼‹èªªæ˜ -->
    <section id="welcomeScreen" class="screen active">
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fa-solid fa-hat-wizard"></i>
            <span>å…ˆç™»å…¥ä½ çš„ä¸‰è§’å½¢èº«ä»½</span>
          </div>
          <div class="badge">Step 1ï½œè¼¸å…¥åå­—æ‰å¯ä»¥é–‹å§‹éŠæˆ²</div>
        </div>
        <div class="card-body">
          <div class="two-column">
            <div>
              <div class="input-row">
                <label for="playerName">ç©å®¶åç¨±ï¼ˆå°‡æœƒå‡ºç¾åœ¨æ’è¡Œæ¦œä¸Šï¼‰</label>
                <input id="playerName" class="text-input" type="text" maxlength="12" placeholder="ä¾‹ï¼šä¸‰è§’å°å»ºç¯‰å¸«ã€å…¨ç­‰å¤§å¸«â€¦" />
              </div>
              <button id="btnEnterGame" class="btn btn-primary btn-full" disabled>
                <i class="fa-solid fa-right-to-bracket"></i>
                <span>ç¢ºèªç™»å…¥ï¼Œå‰å¾€é—œå¡é¸å–®</span>
              </button>

              <p class="hint-text">
                å°æé†’ï¼šåå­—ä¸€æ—¦é€å‡ºï¼Œä¹‹å¾Œæ’è¡Œæ¦œéƒ½æœƒç”¨é€™å€‹åå­—å–”ï½å¯ä»¥é…·ã€å¯ä»¥å¯æ„›ï¼Œä½†ä¸è¦ç•™çœŸå¯¦å…¨åã€‚
              </p>
            </div>
            <div>
              <div class="pill">
                <i class="fa-solid fa-circle-play"></i>
                <span>é€™å€‹éŠæˆ²æ€éº¼ç©ï¼Ÿ</span>
              </div>
              <ul class="bullet-list">
                <li>
                  <span class="bullet-dot"></span>
                  <span>å…±æœ‰ <strong>ä¸‰å€‹é—œå¡</strong>ï¼šä¸‰è§’å½¢åˆ†é¡ã€ç•«åœ–æ¢ä»¶åˆ¤æ–·ã€å…¨ç­‰åˆ¤æ–·ã€‚</span>
                </li>
                <li>
                  <span class="bullet-dot"></span>
                  <span>æ¯ä¸€å±€ä¸€é–‹å§‹æœ‰ <strong>60 ç§’</strong>ï¼Œ<strong>ç­”å° +5 ç§’ã€ç­”éŒ¯ -5 ç§’</strong>ï¼Œæ™‚é–“æ­¸é›¶å°±çµæŸã€‚</span>
                </li>
                <li>
                  <span class="bullet-dot"></span>
                  <span>é€£çºŒç­”å°æœƒå•Ÿå‹• <strong>Combo é€£æ“ŠåŠ æˆ</strong>ï¼Œåˆ†æ•¸è¶Šä¾†è¶Šé«˜ã€‚</span>
                </li>
                <li>
                  <span class="bullet-dot"></span>
                  <span>éŠæˆ²çµæŸæœƒä¾ç…§åˆ†æ•¸çµ¦ <strong>â˜…ï½â˜…â˜…â˜… æ˜Ÿç­‰</strong>ï¼Œä¸¦è‡ªå‹•å­˜é€²æ’è¡Œæ¦œã€‚</span>
                </li>
                <li>
                  <span class="bullet-dot"></span>
                  <span>å¯ä»¥åœ¨ <strong>ç°¡å–® / æ™®é€š / æŒ‘æˆ°</strong> é›£åº¦ä¹‹é–“åˆ‡æ›ï¼Œè®“è‡ªå·±è¶Šä¾†è¶Šå¼·ã€‚</span>
                </li>
              </ul>
              <div class="chips-row">
                <span class="chip"><i class="fa-solid fa-shapes"></i> ä¸‰è§’å½¢åˆ†é¡</span>
                <span class="chip"><i class="fa-solid fa-pencil"></i> ç•«åœ–æ¢ä»¶</span>
                <span class="chip"><i class="fa-solid fa-equals"></i> å…¨ç­‰æ¦‚å¿µ</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Screen 2ï¼šé—œå¡ï¼‹é›£åº¦ï¼‹æ’è¡Œæ¦œ -->
    <section id="menuScreen" class="screen">
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fa-solid fa-list-check"></i>
            <span>é—œå¡ä¸»é¸å–®</span>
          </div>
          <div class="badge" id="greetingBadge">ç©å®¶ï¼š</div>
        </div>
        <div class="card-body">
          <div class="menu-grid">
            <!-- å·¦å´ï¼šé¸é—œï¼‹é›£åº¦ -->
            <div>
              <div class="section-title">
                <i class="fa-solid fa-flag-checkered"></i>
                <span>1. é¸æ“‡é—œå¡</span>
              </div>
              <div class="level-buttons" id="levelButtons">
                <button class="btn-pill-toggle" data-level="1">
                  <i class="fa-solid fa-layer-group"></i>
                  <span>ç¬¬ä¸€é—œï½œä¸‰è§’å½¢åˆ†é¡</span>
                </button>
                <button class="btn-pill-toggle" data-level="2">
                  <i class="fa-solid fa-pencil"></i>
                  <span>ç¬¬äºŒé—œï½œç•«ä»€éº¼ä¸‰è§’å½¢</span>
                </button>
                <button class="btn-pill-toggle" data-level="3">
                  <i class="fa-solid fa-equals"></i>
                  <span>ç¬¬ä¸‰é—œï½œåœ–å½¢å…¨ç­‰åˆ¤æ–·</span>
                </button>
              </div>

              <div class="section-title" style="margin-top:8px;">
                <i class="fa-solid fa-gauge-high"></i>
                <span>2. é¸æ“‡é›£åº¦ / é€Ÿåº¦æ„Ÿ</span>
              </div>
              <div class="difficulty-buttons" id="difficultyButtons">
                <button class="btn-pill-toggle" data-diff="easy">
                  <i class="fa-solid fa-feather-pointed"></i>
                  <span>ç°¡å–®æš–èº«</span>
                </button>
                <button class="btn-pill-toggle" data-diff="normal">
                  <i class="fa-solid fa-fire"></i>
                  <span>æ™®é€šæŒ‘æˆ°</span>
                </button>
                <button class="btn-pill-toggle" data-diff="hard">
                  <i class="fa-solid fa-bolt"></i>
                  <span>æ¿€çƒˆç˜‹ç‹‚</span>
                </button>
              </div>

              <button id="btnStartLevel" class="btn btn-primary btn-full" disabled style="margin-top:8px;">
                <i class="fa-solid fa-circle-play"></i>
                <span>é–‹å§‹æœ¬é—œéŠæˆ²</span>
              </button>

              <p class="hint-text">
                å»ºè­°æµç¨‹ï¼šå…ˆç”¨ã€Œç°¡å–®ã€ç†Ÿæ‚‰é¡Œå‹ â†’ å†è§£é–ã€Œæ™®é€šã€ â†’ æœ€å¾ŒæŒ‘æˆ°ã€Œæ¿€çƒˆç˜‹ç‹‚ã€ï¼Œè®“ä¸‰è§’å½¢æ¦‚å¿µè¶Šä¾†è¶Šç©©ã€‚
              </p>
            </div>

            <!-- å³å´ï¼šæ’è¡Œæ¦œ -->
            <div>
              <div class="section-title">
                <i class="fa-solid fa-ranking-star"></i>
                <span>ä¸‰è§’å½¢å…¨ç­‰æ’è¡Œæ¦œ</span>
              </div>
              <div class="leaderboard-card" id="leaderboard">
                <div class="leader-row header">
                  <div>ç©å®¶</div>
                  <div>é—œå¡</div>
                  <div>é›£åº¦</div>
                  <div>åˆ†æ•¸</div>
                </div>
                <!-- æˆç¸¾åˆ—ç”± JS å¡«å…¥ -->
              </div>
              <p class="hint-text">
                æ¯ä¸€å±€çµæŸéƒ½æœƒè‡ªå‹•å¯«å…¥æ’è¡Œæ¦œï¼ˆåŒ…å«æŒ‰ä¸‹ã€Œå›é—œå¡ä¸»é¸å–®ã€çµæŸçš„å±€ï¼‰ï¼Œæ–¹ä¾¿è€å¸«è¿½è¹¤ç·´ç¿’ç´€éŒ„ã€‚
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Screen 3ï¼šéŠæˆ²ç•«é¢ -->
    <section id="gameScreen" class="screen">
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fa-solid fa-gamepad"></i>
            <span id="gameHeaderTitle">ä¸‰è§’å½¢å°æ±ºä¸­â€¦</span>
          </div>
          <div class="badge" id="gameInfoBadge">ç©å®¶ï¼š</div>
        </div>
        <div class="card-body">
          <div class="game-top">
            <div class="timer-wrap">
              <div class="timer-bar-bg">
                <div id="timerBar" class="timer-bar-fill" style="width:100%;"></div>
              </div>
              <div class="timer-text">
                <span>å‰©é¤˜æ™‚é–“ï¼š<strong id="timeLabel">60 ç§’</strong></span>
                <span>æ¯ç­”å° +5 ç§’ Â· æ¯ç­”éŒ¯ -5 ç§’</span>
              </div>
            </div>
            <div class="status-item">
              <span class="status-label">åˆ†æ•¸ï¼š</span>
              <span id="scoreLabel">0</span>
            </div>
            <div class="status-item">
              <span class="status-label">Comboï¼š</span>
              <span id="comboLabel">x1</span>
            </div>
            <div class="status-item">
              <span class="status-label">é—œå¡ï¼š</span>
              <span id="statusLevel">â€”</span>
            </div>
            <div class="status-item">
              <span class="status-label">é›£åº¦ï¼š</span>
              <span id="statusDiff">â€”</span>
            </div>
          </div>

          <div class="game-main" id="gameMain">
            <!-- æš«åœé®ç½© -->
            <div id="pauseOverlay" class="pause-overlay">
              <div class="pause-box">
                <h3><i class="fa-solid fa-pause"></i> å·²æš«åœéŠæˆ²</h3>
                <p>å–å£æ°´ã€å‹•å‹•æ‰‹ï¼Œå†æŒ‰ä¸€æ¬¡ã€Œç¹¼çºŒã€å›åˆ°ä¸‰è§’å½¢æˆ°å ´ã€‚</p>
              </div>
            </div>

            <!-- é¡Œç›®å€ -->
            <div class="question-card">
              <div class="question-title">
                <i class="fa-solid fa-lightbulb"></i>
                <span>è«‹é¸å‡ºæ­£ç¢ºç­”æ¡ˆ</span>
                <span id="questionFlag" class="flag">ä¸‰è§’å½¢ä»»å‹™</span>
              </div>
              <div id="questionText" class="question-text">
                é¡Œç›®è¼‰å…¥ä¸­â€¦
              </div>
              <div id="optionsContainer" class="options-grid">
                <!-- é¸é …ç”± JS å‹•æ…‹ç”Ÿæˆ -->
              </div>
              <div id="feedback" class="feedback"></div>
            </div>

            <!-- åŸæœ¬æƒ…å¢ƒæ’åœ–å¡å€å¡Šå·²éš±è—ï¼ˆCSS ä¸­ display:noneï¼‰ -->
            <aside class="story-card">
              <div>
                <div class="story-label">
                  <i class="fa-solid fa-image"></i>
                  <span>æƒ…å¢ƒæ’åœ–å¡ Â· å°å°ä¸‰è§’å½¢ä»»å‹™</span>
                </div>
                <div id="storyText" class="story-text">
                  æœ‰ä¸€ä½å°å°å»ºç¯‰å¸«ï¼Œæ­£è¦ç”¨ä¸‰è§’å½¢æ­å»ºä¸€åº§ç©©å›ºçš„æ©‹ã€‚ä»–éœ€è¦ä½ çš„åˆ¤æ–·ï¼šå“ªä¸€ç¨®ä¸‰è§’å½¢æœ€é©åˆã€å“ªä¸€äº›é‚Šé•·å¯ä»¥æˆåŠŸå®Œæˆè¨­è¨ˆï¼Ÿ
                </div>
                <div class="story-tag-row">
                  <span class="story-tag" id="storyTag1">åˆ†é¡ä¸‰è§’å½¢</span>
                  <span class="story-tag" id="storyTag2">é‚Šèˆ‡è§’å°æ‡‰</span>
                  <span class="story-tag" id="storyTag3">å…¨ç­‰ä¿è­‰ç©©å›º</span>
                </div>
              </div>
              <div class="story-emoji" id="storyEmoji">ğŸ“âœ¨</div>
            </aside>
          </div>

          <div class="game-actions">
            <button id="btnPause" class="btn btn-warning">
              <i class="fa-solid fa-pause"></i>
              <span>æš«åœ</span>
            </button>
            <button id="btnRestart" class="btn btn-ghost">
              <i class="fa-solid fa-rotate-right"></i>
              <span>é‡æ–°æœ¬å±€</span>
            </button>
            <button id="btnBackToMenu" class="btn btn-danger">
              <i class="fa-solid fa-door-open"></i>
              <span>å›é—œå¡ä¸»é¸å–®</span>
            </button>
          </div>

        </div>
      </div>
    </section>
  </main>
</div>

<!-- çµç®— Modal -->
<div id="resultModal" class="modal-backdrop">
  <div class="modal-panel">
    <div class="modal-inner">
      <div class="modal-header">
        <div class="modal-title">
          <span class="icon"><i class="fa-solid fa-trophy"></i></span>
          <span>æœ¬å±€çµç®—ï½œä¸‰è§’å½¢æˆ°å ±</span>
        </div>
        <button class="modal-close" id="btnCloseModal" aria-label="é—œé–‰">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="result-main">
        <div class="result-row">
          <span class="result-label">ç©å®¶ï¼š</span>
          <span class="result-value" id="resultPlayer">â€”</span>
        </div>
        <div class="result-row">
          <span class="result-label">é—œå¡ï¼š</span>
          <span class="result-value" id="resultLevel">â€”</span>
        </div>
        <div class="result-row">
          <span class="result-label">é›£åº¦ï¼š</span>
          <span class="result-value" id="resultDiff">â€”</span>
        </div>
        <div class="result-row">
          <span class="result-label">æœ€å¾Œåˆ†æ•¸ï¼š</span>
          <span class="result-value" id="resultScore">0</span>
        </div>
        <div class="result-row">
          <span class="result-label">æœ€é«˜é€£æ“Šï¼š</span>
          <span class="result-value" id="resultCombo">x1</span>
        </div>
        <div class="big-stars" id="resultStars">â˜† â˜† â˜†</div>
        <div class="result-row">
          <span class="result-label">æœ¬å±€ç‹€æ…‹ï¼š</span>
          <span class="result-value" id="resultStatus">æ™‚é–“åˆ°ï¼Œè‡ªç„¶çµæŸ</span>
        </div>
      </div>

      <div class="modal-actions">
        <button id="btnSaveRecord" class="btn-outline btn-save" disabled>
          <i class="fa-solid fa-floppy-disk"></i>
          <span>æˆç¸¾å·²è‡ªå‹•å­˜å…¥æ’è¡Œæ¦œ</span>
        </button>
        <button id="btnPlayAgain" class="btn-outline">
          <i class="fa-solid fa-rotate-right"></i>
          <span>åŒé—œå†æˆ°ä¸€æ¬¡</span>
        </button>
        <button id="btnBackToMenuFromModal" class="btn-outline">
          <i class="fa-solid fa-list-ul"></i>
          <span>å›é—œå¡ä¸»é¸å–®</span>
        </button>
      </div>
      <p class="modal-note">
        æé†’ï¼šæœ¬å±€æˆç¸¾å·²è‡ªå‹•å¯«å…¥æ’è¡Œæ¦œã€‚æŒ‰ä¸‹ã€Œå›é—œå¡ä¸»é¸å–®ã€å¯ä»¥å›å»é¸é—œç¹¼çºŒæŒ‘æˆ°ã€‚
      </p>
    </div>
  </div>
</div>

<script>
  // ====== å…¨åŸŸç‹€æ…‹ ======
  const state = {
    playerName: '',
    currentLevel: null, // 1 / 2 / 3
    difficulty: null,   // 'easy' / 'normal' / 'hard'
    timeLeft: 60,
    score: 0,
    combo: 0,
    maxCombo: 0,
    timerId: null,
    isPaused: false,
    inGame: false,
    lastResult: null,   // çµç®—è³‡æ–™
    currentQuestion: null
  };

  const leaderboardData = []; // {name, level, difficulty, score, stars}

  const LS_KEY = 'JM_TRIANGLE_CONGRUENCE_LEADERBOARD_V1';

  // ====== DOM ======
  const screens = {
    welcome: document.getElementById('welcomeScreen'),
    menu: document.getElementById('menuScreen'),
    game: document.getElementById('gameScreen'),
  };

  const playerNameInput = document.getElementById('playerName');
  const btnEnterGame = document.getElementById('btnEnterGame');
  const greetingBadge = document.getElementById('greetingBadge');

  const levelButtonsWrap = document.getElementById('levelButtons');
  const difficultyButtonsWrap = document.getElementById('difficultyButtons');
  const btnStartLevel = document.getElementById('btnStartLevel');

  const leaderboardEl = document.getElementById('leaderboard');

  // Game screen elements
  const gameHeaderTitle = document.getElementById('gameHeaderTitle');
  const gameInfoBadge = document.getElementById('gameInfoBadge');
  const timeLabel = document.getElementById('timeLabel');
  const timerBar = document.getElementById('timerBar');
  const scoreLabel = document.getElementById('scoreLabel');
  const comboLabel = document.getElementById('comboLabel');
  const statusLevel = document.getElementById('statusLevel');
  const statusDiff = document.getElementById('statusDiff');
  const questionTextEl = document.getElementById('questionText');
  const optionsContainer = document.getElementById('optionsContainer');
  const feedbackEl = document.getElementById('feedback');
  const questionFlag = document.getElementById('questionFlag');
  const pauseOverlay = document.getElementById('pauseOverlay');

  const btnPause = document.getElementById('btnPause');
  const btnRestart = document.getElementById('btnRestart');
  const btnBackToMenu = document.getElementById('btnBackToMenu');

  // Modal
  const resultModal = document.getElementById('resultModal');
  const btnCloseModal = document.getElementById('btnCloseModal');
  const btnSaveRecord = document.getElementById('btnSaveRecord');
  const btnPlayAgain = document.getElementById('btnPlayAgain');
  const btnBackToMenuFromModal = document.getElementById('btnBackToMenuFromModal');

  const resultPlayer = document.getElementById('resultPlayer');
  const resultLevel = document.getElementById('resultLevel');
  const resultDiff = document.getElementById('resultDiff');
  const resultScore = document.getElementById('resultScore');
  const resultCombo = document.getElementById('resultCombo');
  const resultStars = document.getElementById('resultStars');
  const resultStatus = document.getElementById('resultStatus');

  // ====== Helper ======
  function showScreen(key){
    Object.values(screens).forEach(s => s.classList.remove('active'));
    screens[key].classList.add('active');
  }

  function shuffle(array){
    const arr = array.slice();
    for(let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function levelLabel(level){
    if(level === 1) return 'ç¬¬ä¸€é—œï½œä¸‰è§’å½¢åˆ†é¡';
    if(level === 2) return 'ç¬¬äºŒé—œï½œç•«ä»€éº¼ä¸‰è§’å½¢';
    if(level === 3) return 'ç¬¬ä¸‰é—œï½œåœ–å½¢å…¨ç­‰åˆ¤æ–·';
    return 'â€”';
  }
  function diffLabel(diff){
    if(diff === 'easy') return 'ç°¡å–®æš–èº«';
    if(diff === 'normal') return 'æ™®é€šæŒ‘æˆ°';
    if(diff === 'hard') return 'æ¿€çƒˆç˜‹ç‹‚';
    return 'â€”';
  }

  function calcStars(score, diff){
    let t1, t2;
    if(diff === 'easy'){ t1 = 80; t2 = 150; }
    else if(diff === 'normal'){ t1 = 100; t2 = 180; }
    else { t1 = 120; t2 = 220; } // hard
    if(score <= 0) return 0;
    if(score >= t2) return 3;
    if(score >= t1) return 2;
    return 1;
  }

  function starsToString(starCount){
    if(starCount === 3) return 'â˜…â˜…â˜…';
    if(starCount === 2) return 'â˜…â˜…â˜†';
    if(starCount === 1) return 'â˜…â˜†â˜†';
    return 'â˜†â˜†â˜†';
  }

  function updateTimerUI(){
    timeLabel.textContent = state.timeLeft + ' ç§’';
    const ratio = Math.max(0, Math.min(1, state.timeLeft / 60));
    timerBar.style.width = (ratio * 100) + '%';
  }

  function updateScoreUI(){
    scoreLabel.textContent = state.score;
    const combo = Math.max(1, state.combo);
    comboLabel.textContent = 'x' + combo;
  }

  function setOptionsDisabled(disabled){
    const btns = optionsContainer.querySelectorAll('.option-btn');
    btns.forEach(btn => {
      if(disabled) btn.classList.add('disabled');
      else btn.classList.remove('disabled');
    });
  }

  // ====== é¡Œç›®ç”¢ç”Ÿå™¨ ======

  // Level 1ï¼šä¸‰è§’å½¢åˆ†é¡
  function generateLevel1Question(){
    const useSide = Math.random() < 0.5;

    const sideTemplates = [
      { sides:[5,5,5], type:'ç­‰é‚Šä¸‰è§’å½¢' },
      { sides:[4,4,7], type:'ç­‰è…°ä¸‰è§’å½¢' },
      { sides:[3,4,5], type:'ä¸ç­‰é‚Šä¸‰è§’å½¢' },
      { sides:[6,6,9], type:'ç­‰è…°ä¸‰è§’å½¢' },
      { sides:[4,5,7], type:'ä¸ç­‰é‚Šä¸‰è§’å½¢' }
    ];
    const angleTemplates = [
      { angles:[60,60,60], type:'éŠ³è§’ä¸‰è§’å½¢' },
      { angles:[30,60,90], type:'ç›´è§’ä¸‰è§’å½¢' },
      { angles:[40,40,100], type:'éˆè§’ä¸‰è§’å½¢' },
      { angles:[25,65,90], type:'ç›´è§’ä¸‰è§’å½¢' },
      { angles:[20,60,100], type:'éˆè§’ä¸‰è§’å½¢' }
    ];
    const sideTypes = ['ç­‰é‚Šä¸‰è§’å½¢','ç­‰è…°ä¸‰è§’å½¢','ä¸ç­‰é‚Šä¸‰è§’å½¢'];
    const angleTypes = ['éŠ³è§’ä¸‰è§’å½¢','ç›´è§’ä¸‰è§’å½¢','éˆè§’ä¸‰è§’å½¢'];

    let text, correct, options;

    if(useSide){
      const tpl = sideTemplates[Math.floor(Math.random()*sideTemplates.length)];
      const [a,b,c] = tpl.sides;
      text = `å·²çŸ¥ä¸€å€‹ä¸‰è§’å½¢çš„ä¸‰é‚Šé•·ä¾åºç‚º ${a} å…¬åˆ†ã€${b} å…¬åˆ†ã€${c} å…¬åˆ†ï¼Œä¾ã€Œé‚Šé•·ã€ä¾†åˆ†é¡ï¼Œå®ƒæ˜¯å“ªä¸€ç¨®ä¸‰è§’å½¢ï¼Ÿ`;
      correct = tpl.type;
      options = shuffle(sideTypes);
    }else{
      const tpl = angleTemplates[Math.floor(Math.random()*angleTemplates.length)];
      const [A,B,C] = tpl.angles;
      text = `æœ‰ä¸€å€‹ä¸‰è§’å½¢çš„ä¸‰å€‹å…§è§’åˆ†åˆ¥ç‚º ${A}Â°ã€${B}Â°ã€${C}Â°ï¼Œä¾ã€Œè§’åº¦ã€ä¾†åˆ†é¡ï¼Œå®ƒæ˜¯å“ªä¸€ç¨®ä¸‰è§’å½¢ï¼Ÿ`;
      correct = tpl.type;
      options = shuffle(angleTypes);
    }

    const correctIndex = options.indexOf(correct);
    return {
      text,
      options,
      correctIndex,
      explanation: `æ­£ç¢ºç­”æ¡ˆæ˜¯ã€Œ${correct}ã€ã€‚æ³¨æ„é‚Šé•·æ˜¯å¦å…¨éƒ¨ä¸€æ¨£ã€å…©é‚Šä¸€æ¨£ï¼Œæˆ–ä¸‰é‚Šéƒ½ä¸ä¸€æ¨£ï¼›è§’åº¦å‰‡çœ‹æœ‰æ²’æœ‰ 90Â° æˆ–æ˜¯æœ‰æ²’æœ‰å¤§æ–¼ 90Â°ã€‚`
    };
  }

  // Level 2ï¼šç•«ä»€éº¼ä¸‰è§’å½¢ï¼ˆæ›´ç²¾æº–çš„ç•«åœ–æ¢ä»¶é¡Œï¼‰
  function generateLevel2Question(){
    const templates = [
      {
        text:'å¦‚æœè€å¸«è«‹ä½ ã€Œç•«ä¸€å€‹ç­‰é‚Šä¸‰è§’å½¢ã€ï¼Œä¸‹é¢å“ªä¸€å€‹æé†’æœ€æ­£ç¢ºï¼Ÿ',
        options:[
          'ä¸‰æ¢é‚Šéƒ½ç•«æˆå·®ä¸å¤šä¸€æ¨£é•·',
          'å…¶ä¸­å…©æ¢é‚Šä¸€æ¨£é•·ï¼Œç¬¬ä¸‰é‚Šæ˜é¡¯æ¯”è¼ƒçŸ­',
          'ä¸‰æ¢é‚Šé•·åº¦å·®å¾ˆå¤šï¼Œå®Œå…¨ä¸ä¸€æ¨£',
          'åªè¦ç•«å‡ºä¸€å€‹æœ‰ç›´è§’çš„ä¸‰è§’å½¢å°±å¯ä»¥'
        ],
        correctIndex:0,
        explanation:'ç­‰é‚Šä¸‰è§’å½¢çš„ä¸‰æ¢é‚Šé•·åº¦éƒ½ç›¸åŒï¼Œæ¯ä¸€é‚Šçœ‹èµ·ä¾†å·®ä¸å¤šé•·ã€‚'
      },
      {
        text:'å¦‚æœè¦åœ¨ç´™ä¸Šç•«ä¸€å€‹ã€Œç­‰è…°ä¸‰è§’å½¢ã€ï¼Œä½ æœ€éœ€è¦æ³¨æ„çš„æ˜¯ä»€éº¼ï¼Ÿ',
        options:[
          'è¦æœ‰å…©æ¢é‚Šçœ‹èµ·ä¾†ä¸€æ¨£é•·',
          'ä¸‰æ¢é‚Šéƒ½ä¸€æ¨£é•·æ‰è¡Œ',
          'ä¸€å®šè¦æœ‰ä¸€å€‹ç›´è§’',
          'ä¸‰å€‹è§’éƒ½ä¸€æ¨£å¤§æ‰ç®—'
        ],
        correctIndex:0,
        explanation:'ç­‰è…°ä¸‰è§’å½¢æœ‰å…©æ¢é‚Šä¸€æ¨£é•·ï¼Œç¬¬ä¸‰æ¢é‚Šå¯ä»¥æ¯”è¼ƒé•·æˆ–æ¯”è¼ƒçŸ­ã€‚'
      },
      {
        text:'è€å¸«èªªï¼šã€Œè«‹ä½ ç•«ä¸€å€‹ä¸ç­‰é‚Šä¸‰è§’å½¢ã€‚ã€ä¸‹åˆ—å“ªä¸€å€‹åšæ³•æ˜¯æ­£ç¢ºçš„ï¼Ÿ',
        options:[
          'ä¸‰æ¢é‚Šéƒ½ç•«æˆä¸åŒé•·åº¦',
          'ä¸‰æ¢é‚Šç•«å¾—å·®ä¸å¤šä¸€æ¨£é•·',
          'å…ˆç•«ä¸€å€‹ç›´è§’ï¼Œå†éš¨ä¾¿è£œä¸Šå…©æ¢é‚Š',
          'ç•«æˆä¸€å€‹çœ‹èµ·ä¾†åƒé•·æ–¹å½¢çš„åœ–å½¢'
        ],
        correctIndex:0,
        explanation:'ä¸ç­‰é‚Šä¸‰è§’å½¢çš„ä¸‰æ¢é‚Šé•·åº¦éƒ½ä¸ä¸€æ¨£ã€‚'
      },
      {
        text:'å¦‚æœè¦ç•«å‡ºä¸€å€‹ã€Œç›´è§’ä¸‰è§’å½¢ã€ï¼Œå“ªä¸€å€‹æè¿°æœ€ç¬¦åˆï¼Ÿ',
        options:[
          'å…¶ä¸­ä¸€å€‹è§’ç•«æˆåƒæ­£æ–¹å½¢è§’è½ä¸€æ¨£çš„ç›´è§’',
          'ä¸‰å€‹è§’éƒ½ç•«å¾—å°–å°–çš„ï¼Œæ¯” 90Â° å°',
          'ä¸‰å€‹è§’éƒ½ç•«æˆéˆéˆçš„å¤§è§’',
          'åªè¦ä¸‰æ¢é‚Šé•·åº¦ä¸åŒå°±å¯ä»¥'
        ],
        correctIndex:0,
        explanation:'ç›´è§’ä¸‰è§’å½¢æœ‰ä¸€å€‹è§’æ˜¯ 90Â°ï¼Œçœ‹èµ·ä¾†åƒæ­£æ–¹å½¢è§’è½çš„å°æ–¹è§’ã€‚'
      },
      {
        text:'ã€Œè«‹ç•«ä¸€å€‹éŠ³è§’ä¸‰è§’å½¢ã€ï¼Œä¸‹åˆ—å“ªä¸€å€‹èªªæ³•æ˜¯å°çš„ï¼Ÿ',
        options:[
          'ä¸‰å€‹è§’éƒ½æ¯” 90Â° å°ï¼Œçœ‹èµ·ä¾†éƒ½å°–å°–çš„',
          'è¦æœ‰ä¸€å€‹è§’å‰›å¥½ 90Â°',
          'ä¸€å®šè¦æœ‰ä¸€å€‹è§’æ¯” 90Â° å¤§',
          'åªè¦ä¸‰æ¢é‚Šä¸€æ¨£é•·å°±å¯ä»¥'
        ],
        correctIndex:0,
        explanation:'éŠ³è§’ä¸‰è§’å½¢çš„ä¸‰å€‹è§’éƒ½å°æ–¼ 90Â°ï¼Œæ‰€ä»¥æ•´å€‹çœ‹èµ·ä¾†æ¯”è¼ƒå°–ã€‚'
      },
      {
        text:'è€å¸«è«‹åŒå­¸ç•«ã€Œéˆè§’ä¸‰è§’å½¢ã€ï¼Œå“ªä¸€ä½åŒå­¸çš„æè¿°æ¯”è¼ƒæ­£ç¢ºï¼Ÿ',
        options:[
          'æˆ‘æœƒç•«ä¸€å€‹è§’ç‰¹åˆ¥å¤§ï¼Œæ¯” 90Â° é‚„è¦å¤§',
          'æˆ‘æœƒç•«ä¸‰å€‹è§’éƒ½å¾ˆå°',
          'æˆ‘æœƒç•«ä¸€å€‹æœ‰ç›´è§’çš„ä¸‰è§’å½¢',
          'æˆ‘åªè¦ç•«ä¸‰æ¢é‚Šéƒ½ä¸€æ¨£é•·'
        ],
        correctIndex:0,
        explanation:'éˆè§’ä¸‰è§’å½¢ä¸€å®šæœƒæœ‰ä¸€å€‹è§’å¤§æ–¼ 90Â°ï¼Œçœ‹èµ·ä¾†ç‰¹åˆ¥ã€Œéˆã€ã€‚'
      },
      {
        text:'å¦‚æœä½ åœ¨ç´™ä¸Šç•«äº†ä¸€å€‹ä¸‰è§’å½¢ï¼Œçœ‹èµ·ä¾†ã€Œä¸Šé¢å°–å°–ã€å·¦å³å…©é‚Šå·®ä¸å¤šé•·ã€ï¼Œæœ€æ¥è¿‘å“ªä¸€ç¨®ï¼Ÿ',
        options:[
          'ç­‰è…°ä¸‰è§’å½¢',
          'ç­‰é‚Šä¸‰è§’å½¢',
          'ä¸ç­‰é‚Šä¸‰è§’å½¢',
          'é•·æ–¹å½¢'
        ],
        correctIndex:0,
        explanation:'ä¸Šé¢ä¸€å€‹å°–è§’ï¼Œå·¦å³å…©é‚Šå·®ä¸å¤šé•·ï¼Œå¸¸è¦‹çš„æ˜¯ç­‰è…°ä¸‰è§’å½¢ã€‚'
      }
    ];

    const tpl = templates[Math.floor(Math.random()*templates.length)];
    return {
      text: tpl.text,
      options: tpl.options.slice(),
      correctIndex: tpl.correctIndex,
      explanation: tpl.explanation + ' å¯¦éš›åœ¨ç´™ä¸Šç•«çš„æ™‚å€™ï¼Œåªè¦å¤§è‡´ç¬¦åˆé€™å€‹ç‰¹å¾µå°±å¯ä»¥ï¼Œä¸ç”¨ç•«å¾—å®Œç¾ã€‚'
    };
  }

  // Level 3ï¼šåœ–å½¢å…¨ç­‰åˆ¤åˆ¥ï¼ˆå¤šå…ƒç”Ÿæ´»é¡Œå‹ï¼‰
  function generateLevel3Question(){
    const templates = [
      {
        text:'åœ–å½¢ç”²å’Œåœ–å½¢ä¹™éƒ½æ˜¯ä¸‰è§’å½¢ï¼Œå¤§å°ã€å½¢ç‹€å®Œå…¨ä¸€æ¨£ï¼Œåªæ˜¯ä¹™è¢«ã€Œæ—‹è½‰ã€äº†ä¸€ä¸‹ã€‚è«‹å•é€™å…©å€‹åœ–å½¢æ˜¯ä¸æ˜¯å…¨ç­‰ï¼Ÿ',
        options:[
          'æ˜¯ï¼Œå…¨ç­‰ï¼Œåªæ˜¯æ–¹å‘ä¸åŒè€Œå·²',
          'ä¸æ˜¯ï¼Œå…¨ç­‰ç­‰ä¸€å®šè¦æ–¹å‘ä¸€æ¨¡ä¸€æ¨£'
        ],
        correctIndex:0,
        explanation:'å…¨ç­‰åªçœ‹å¤§å°å’Œå½¢ç‹€ï¼Œæœ‰æ²’æœ‰æ—‹è½‰ã€ç¿»è½‰éƒ½æ²’é—œä¿‚ã€‚'
      },
      {
        text:'åœ–å½¢ç”²å’Œåœ–å½¢ä¹™éƒ½æ˜¯é•·æ–¹å½¢ã€‚ç”²çš„é•·æ˜¯ 6 æ ¼ã€å¯¬æ˜¯ 3 æ ¼ï¼›ä¹™çš„é•·æ˜¯ 6 æ ¼ã€å¯¬ä¹Ÿæ˜¯ 3 æ ¼ï¼Œåªæ˜¯æ”¾æˆç›´çš„ã€‚å®ƒå€‘æ˜¯ä¸æ˜¯å…¨ç­‰ï¼Ÿ',
        options:[
          'æ˜¯ï¼Œå…¨ç­‰ï¼Œå› ç‚ºé•·å’Œå¯¬éƒ½ä¸€æ¨£',
          'ä¸æ˜¯ï¼Œå› ç‚ºä¸€å€‹æ˜¯æ©«çš„ã€ä¸€å€‹æ˜¯ç›´çš„'
        ],
        correctIndex:0,
        explanation:'é•·æ–¹å½¢åªè¦é•·å’Œå¯¬ä¸€æ¨£é•·ï¼Œå…©å€‹åœ–å½¢å¤§å°å’Œå½¢ç‹€å°±å®Œå…¨ç›¸åŒï¼Œæ˜¯å…¨ç­‰çš„ã€‚'
      },
      {
        text:'åœ–å½¢ç”²æ˜¯å°æ­£æ–¹å½¢ï¼Œé‚Šé•· 2 æ ¼ï¼›åœ–å½¢ä¹™æ˜¯å¤§æ­£æ–¹å½¢ï¼Œé‚Šé•· 4 æ ¼ã€‚è«‹å•é€™å…©å€‹åœ–å½¢æ˜¯ä¸æ˜¯å…¨ç­‰ï¼Ÿ',
        options:[
          'ä¸æ˜¯ï¼Œå…¨ç­‰è¦å¤§å°ä¸€æ¨£ï¼Œé€™åªæ˜¯æ”¾å¤§ç‰ˆ',
          'æ˜¯ï¼Œå…¨ç­‰ï¼Œåªè¦å½¢ç‹€ä¸€æ¨£å°±å¥½'
        ],
        correctIndex:0,
        explanation:'é‚Šé•·ä¸åŒï¼Œå¤§å°ä¸åŒï¼Œåªèƒ½èªªå½¢ç‹€ç›¸ä¼¼ï¼Œä¸æ˜¯å…¨ç­‰ã€‚'
      },
      {
        text:'åœ–å½¢ç”²å’Œåœ–å½¢ä¹™éƒ½æ˜¯ä¸‰è§’å½¢ï¼Œçœ‹èµ·ä¾†å½¢ç‹€å·®ä¸å¤šï¼Œä½†å…¶ä¸­ä¸€å€‹æ˜é¡¯æ¯”è¼ƒå¤§ã€‚è«‹å•é€™å…©å€‹åœ–å½¢æ˜¯ä¸æ˜¯å…¨ç­‰ï¼Ÿ',
        options:[
          'ä¸æ˜¯ï¼Œå…¨ç­‰è¦å¤§å°å’Œå½¢ç‹€éƒ½ç›¸åŒ',
          'æ˜¯ï¼Œåªè¦è§’åº¦çœ‹èµ·ä¾†å·®ä¸å¤šå°±å¯ä»¥'
        ],
        correctIndex:0,
        explanation:'å…¨ç­‰ä¸€å®šæ˜¯ã€Œå¤§å°ä¸€æ¨£ï¼‹å½¢ç‹€ä¸€æ¨£ã€ï¼Œå…©å€‹æ¢ä»¶éƒ½è¦æœ‰ã€‚'
      },
      {
        text:'åœ–å½¢ç”²å’Œåœ–å½¢ä¹™éƒ½æ˜¯å¥‡æ€ªçš„å¤šé‚Šå½¢ï¼ŒæŠŠå°æ‡‰é‚Šä¸€æ¢ä¸€æ¢é‡èµ·ä¾†éƒ½ä¸€æ¨£é•·ï¼Œå°æ‡‰è§’åº¦çœ‹èµ·ä¾†ä¹Ÿä¸€æ¨£å¤§ã€‚è«‹å•å®ƒå€‘æ˜¯ä¸æ˜¯å…¨ç­‰ï¼Ÿ',
        options:[
          'æ˜¯ï¼Œå…¨ç­‰ï¼Œå› ç‚ºå°æ‡‰é‚Šå’Œå°æ‡‰è§’éƒ½ä¸€æ¨£',
          'ä¸æ˜¯ï¼Œå› ç‚ºå½¢ç‹€å¤ªå¥‡æ€ªäº†ï¼Œä¸èƒ½ç®—å…¨ç­‰'
        ],
        correctIndex:0,
        explanation:'ä¸ç®¡åœ–å½¢é•·æ€æ¨£ï¼Œåªè¦å°æ‡‰é‚Šã€å°æ‡‰è§’éƒ½ä¸€æ¨£ï¼Œå°±æ˜¯å…¨ç­‰åœ–å½¢ã€‚'
      },
      {
        text:'è€å¸«ç•«äº†å…©å€‹æ„›å¿ƒå½¢ç‹€ï¼Œå¤§å°ã€å¯¬åº¦ã€é«˜åº¦éƒ½ä¸€æ¨£ï¼Œåªæ˜¯å…¶ä¸­ä¸€å€‹è¢«ã€Œå·¦å³é¡›å€’ã€è®Šæˆé¡åƒã€‚é€™å…©å€‹æ„›å¿ƒç®—ä¸ç®—å…¨ç­‰ï¼Ÿ',
        options:[
          'ç®—ï¼Œå…¨ç­‰ï¼Œåªæ˜¯é¡åƒç¿»è½‰è€Œå·²',
          'ä¸ç®—ï¼Œå› ç‚ºå·¦å³é¡›å€’å°±ä¸ä¸€æ¨£äº†'
        ],
        correctIndex:0,
        explanation:'åªè¦å¤§å°å’Œå½¢ç‹€ä¸€æ¨£ï¼Œå³ä½¿é¡åƒç¿»è½‰ï¼Œé‚„æ˜¯å…¨ç­‰ã€‚'
      },
      {
        text:'åœ–å½¢ç”²æ˜¯é•·æ–¹å½¢ï¼Œé•· 8 æ ¼ã€å¯¬ 2 æ ¼ï¼›åœ–å½¢ä¹™ä¹Ÿæ˜¯é•·æ–¹å½¢ï¼Œé•· 4 æ ¼ã€å¯¬ 4 æ ¼ã€‚è«‹å•é€™å…©å€‹åœ–å½¢æ˜¯ä¸æ˜¯å…¨ç­‰ï¼Ÿ',
        options:[
          'ä¸æ˜¯ï¼Œé•·å’Œå¯¬çš„é•·åº¦ä¸ä¸€æ¨£',
          'æ˜¯ï¼Œå› ç‚ºé¢ç©çœ‹èµ·ä¾†å·®ä¸å¤š'
        ],
        correctIndex:0,
        explanation:'å…¨ç­‰ä¸æ˜¯çœ‹ã€Œé¢ç©å·®ä¸å¤šã€ï¼Œè€Œæ˜¯è¦å°æ‡‰é‚Šé•·éƒ½ä¸€æ¨£ã€‚'
      },
      {
        text:'å…©å€‹ä¸‰è§’å½¢çš„å°æ‡‰é‚Šé•·éƒ½é‡èµ·ä¾†ä¸€æ¨£é•·ï¼Œä½†å…¶ä¸­ä¸€å€‹ä¸‰è§’å½¢è¢«ã€Œæ‹‰æ‰ã€äº†ä¸€é»ï¼Œçœ‹èµ·ä¾†å¥½åƒæœ‰é»æ­ªã€‚é€™æ¨£é‚„èƒ½èªªå®ƒå€‘å…¨ç­‰å—ï¼Ÿ',
        options:[
          'å¯ä»¥ï¼Œå…¨ç­‰åªçœ‹é‚Šå’Œè§’çš„å¤§å°ï¼Œä¸çœ‹ç•«å¾—æ¼‚ä¸æ¼‚äº®',
          'ä¸è¡Œï¼Œå› ç‚ºçœ‹èµ·ä¾†æ­ªæ‰äº†'
        ],
        correctIndex:0,
        explanation:'å¦‚æœåªæ˜¯ç•«å¾—æœ‰é»æ­ªï¼Œä½†å¯¦éš›é‚Šé•·å’Œè§’åº¦ä¸€æ¨£ï¼Œç†è«–ä¸Šé‚„æ˜¯å…¨ç­‰ã€‚'
      },
      {
        text:'åœ–å½¢ç”²å’Œåœ–å½¢ä¹™éƒ½æ˜¯ä¸‰è§’å½¢ï¼Œåªæœ‰å‘¨é•·ä¸€æ¨£é•·ï¼Œä½†é‚Šé•·çš„çµ„åˆä¸åŒã€‚è«‹å•é€™å…©å€‹ä¸‰è§’å½¢ä¸€å®šå…¨ç­‰å—ï¼Ÿ',
        options:[
          'ä¸ä¸€å®šï¼Œå‘¨é•·ä¸€æ¨£ä¸ä»£è¡¨å½¢ç‹€å’Œå¤§å°å®Œå…¨ç›¸åŒ',
          'ä¸€å®šå…¨ç­‰ï¼Œåªè¦å‘¨é•·ä¸€æ¨£å°±å¯ä»¥'
        ],
        correctIndex:0,
        explanation:'å‘¨é•·åªçœ‹ä¸‰é‚Šç¸½å’Œï¼Œä¸‰é‚Šé•·åº¦çš„çµ„åˆå¯èƒ½ä¸ä¸€æ¨£ï¼Œæ‰€ä»¥ä¸ä¸€å®šå…¨ç­‰ã€‚'
      },
      {
        text:'è€å¸«èªªï¼šã€Œåªè¦å…©å€‹åœ–å½¢çš„æ¯ä¸€æ¢å°æ‡‰é‚Šéƒ½ä¸€æ¨£é•·ã€æ¯ä¸€å€‹å°æ‡‰è§’ä¹Ÿä¸€æ¨£å¤§ï¼Œé‚£å°±æ˜¯å…¨ç­‰åœ–å½¢ã€‚ã€é€™å¥è©±æ˜¯å°çš„å—ï¼Ÿ',
        options:[
          'å°çš„ï¼Œé€™å°±æ˜¯å…¨ç­‰çš„æ„æ€',
          'ä¸å°ï¼Œé‚„è¦é¡è‰²ä¸€æ¨£æ‰ç®—å…¨ç­‰'
        ],
        correctIndex:0,
        explanation:'é¡è‰²ã€èŠ±ç´‹ä¸å½±éŸ¿å…¨ç­‰ï¼Œé‡é»æ˜¯å¤§å°èˆ‡å½¢ç‹€ï¼ˆé‚Šèˆ‡è§’ï¼‰ã€‚'
      }
    ];

    const tpl = templates[Math.floor(Math.random()*templates.length)];
    return {
      text: tpl.text,
      options: tpl.options.slice(),
      correctIndex: tpl.correctIndex,
      explanation: tpl.explanation
    };
  }

  function generateQuestion(){
    let q;
    if(state.currentLevel === 1){
      questionFlag.textContent = 'ç¬¬ä¸€é—œï½œä¸‰è§’å½¢åˆ†é¡';
      q = generateLevel1Question();
    }else if(state.currentLevel === 2){
      questionFlag.textContent = 'ç¬¬äºŒé—œï½œç•«ä»€éº¼ä¸‰è§’å½¢';
      q = generateLevel2Question();
    }else{
      questionFlag.textContent = 'ç¬¬ä¸‰é—œï½œåœ–å½¢å…¨ç­‰åˆ¤æ–·';
      q = generateLevel3Question();
    }
    state.currentQuestion = q;
    renderQuestion(q);
  }

  function renderQuestion(q){
    questionTextEl.textContent = q.text;
    optionsContainer.innerHTML = '';
    feedbackEl.textContent = '';
    feedbackEl.className = 'feedback';

    const letters = ['A','B','C','D'];
    q.options.forEach((opt, idx)=>{
      const btn = document.createElement('button');
      btn.className = 'option-btn';
      btn.dataset.index = idx;

      const left = document.createElement('div');
      left.className = 'option-main';

      const tag = document.createElement('div');
      tag.className = 'choice-tag';
      tag.textContent = letters[idx] || '?';

      const textSpan = document.createElement('div');
      textSpan.textContent = opt;

      left.appendChild(tag);
      left.appendChild(textSpan);

      const arrow = document.createElement('i');
      arrow.className = 'fa-solid fa-chevron-right';
      arrow.style.fontSize = '.75rem';
      arrow.style.color = '#9ca3af';

      btn.appendChild(left);
      btn.appendChild(arrow);

      btn.addEventListener('click', ()=>handleAnswer(idx));
      optionsContainer.appendChild(btn);
    });
  }

  // ====== éŠæˆ²æµç¨‹ ======
  function startGame(){
    // é‡ç½®ç‹€æ…‹
    state.timeLeft = 60;
    state.score = 0;
    state.combo = 0;
    state.maxCombo = 0;
    state.isPaused = false;
    state.inGame = true;
    state.currentQuestion = null;
    clearInterval(state.timerId);

    // UI
    updateTimerUI();
    updateScoreUI();
    btnPause.innerHTML = '<i class="fa-solid fa-pause"></i><span>æš«åœ</span>';
    pauseOverlay.style.display = 'none';
    setOptionsDisabled(false);
    feedbackEl.textContent = '';

    // header æ¨™é¡Œç­‰
    gameHeaderTitle.textContent = levelLabel(state.currentLevel);
    gameInfoBadge.textContent = 'ç©å®¶ï¼š' + (state.playerName || '-');
    statusLevel.textContent = levelLabel(state.currentLevel);
    statusDiff.textContent = diffLabel(state.difficulty);

    // Timer
    state.timerId = setInterval(()=>{
      if(state.isPaused || !state.inGame) return;
      state.timeLeft--;
      if(state.timeLeft <= 0){
        state.timeLeft = 0;
        updateTimerUI();
        endGame('æ™‚é–“åˆ°');
      }else{
        updateTimerUI();
      }
    }, 1000);

    // é¡Œç›®
    generateQuestion();
  }

  function endGame(reason){
    if(!state.inGame) return;
    state.inGame = false;
    state.isPaused = false;
    clearInterval(state.timerId);
    setOptionsDisabled(true);
    pauseOverlay.style.display = 'none';

    // è¨ˆç®—æ˜Ÿç­‰
    const stars = calcStars(state.score, state.difficulty);

    const result = {
      player: state.playerName,
      level: state.currentLevel,
      difficulty: state.difficulty,
      score: state.score,
      maxCombo: state.maxCombo,
      stars,
      reason
    };
    state.lastResult = result;

    // â˜…â˜…â˜… è‡ªå‹•å­˜å…¥æ’è¡Œæ¦œ
    addRecordToLeaderboard(result);

    // å¡«å…¥ modal
    resultPlayer.textContent = result.player || 'â€”';
    resultLevel.textContent = levelLabel(result.level);
    resultDiff.textContent = diffLabel(result.difficulty);
    resultScore.textContent = result.score;
    resultCombo.textContent = 'x' + Math.max(1,result.maxCombo);
    resultStars.textContent = starsToString(result.stars);
    resultStatus.textContent = reason || 'æ™‚é–“åˆ°ï¼Œè‡ªç„¶çµæŸ';

    // æŒ‰éˆ•æç¤ºï¼šå·²è‡ªå‹•å­˜å…¥
    btnSaveRecord.disabled = true;
    btnSaveRecord.querySelector('span').textContent = 'æˆç¸¾å·²è‡ªå‹•å­˜å…¥æ’è¡Œæ¦œ';

    resultModal.classList.add('active');
  }

  // ä¸­é€”é›¢é–‹ï¼šä¹Ÿæœƒå¯«å…¥æ’è¡Œæ¦œï¼Œä½†ä¸è·³çµç®—è¦–çª—ï¼Œç›´æ¥å›ä¸»é¸å–®
  function abortGameToMenu(){
    if(state.inGame){
      state.inGame = false;
      state.isPaused = false;
      clearInterval(state.timerId);
      pauseOverlay.style.display = 'none';
      setOptionsDisabled(true);

      const stars = calcStars(state.score, state.difficulty);
      const result = {
        player: state.playerName,
        level: state.currentLevel,
        difficulty: state.difficulty,
        score: state.score,
        maxCombo: state.maxCombo,
        stars,
        reason: 'ä¸­é€”ä¸­æ­¢'
      };
      state.lastResult = result;
      addRecordToLeaderboard(result);
    }
    showScreen('menu');
  }

  function restartSameGame(){
    if(!state.currentLevel || !state.difficulty) return;
    startGame();
  }

  // ====== æ’è¡Œæ¦œ ======
  function loadLeaderboard(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        const arr = JSON.parse(raw);
        if(Array.isArray(arr)){
          leaderboardData.splice(0,leaderboardData.length,...arr);
        }
      }
    }catch(e){
      console.warn('load leaderboard error', e);
    }
    renderLeaderboard();
  }

  function saveLeaderboard(){
    try{
      localStorage.setItem(LS_KEY, JSON.stringify(leaderboardData.slice(0,30)));
    }catch(e){
      console.warn('save leaderboard error', e);
    }
  }

  function renderLeaderboard(){
    // æ¸…é™¤èˆŠåˆ—ï¼ˆä¿ç•™ headerï¼‰
    const rows = Array.from(leaderboardEl.querySelectorAll('.leader-row:not(.header)'));
    rows.forEach(r => r.remove());

    const sorted = leaderboardData.slice().sort((a,b)=>b.score - a.score);

    sorted.slice(0,15).forEach(item=>{
      const row = document.createElement('div');
      row.className = 'leader-row';
      const nameDiv = document.createElement('div');
      nameDiv.textContent = item.name;
      const levelDiv = document.createElement('div');
      levelDiv.textContent = item.levelLabel;
      const diffDiv = document.createElement('div');
      diffDiv.textContent = item.diffLabel;
      const scoreDiv = document.createElement('div');
      scoreDiv.innerHTML = item.score + ' <span class="star-display">' + starsToString(item.stars) + '</span>';

      row.appendChild(nameDiv);
      row.appendChild(levelDiv);
      row.appendChild(diffDiv);
      row.appendChild(scoreDiv);
      leaderboardEl.appendChild(row);
    });

    if(sorted.length === 0){
      const emptyRow = document.createElement('div');
      emptyRow.className = 'leader-row';
      emptyRow.style.justifyContent = 'center';
      emptyRow.style.gridTemplateColumns = '1fr';
      emptyRow.textContent = 'ç›®å‰é‚„æ²’æœ‰æˆç¸¾ï¼Œå…ˆç©ä¸€å±€è©¦è©¦çœ‹å§ï¼';
      leaderboardEl.appendChild(emptyRow);
    }
  }

  function addRecordToLeaderboard(result){
    const item = {
      name: result.player || 'â€”',
      level: result.level,
      difficulty: result.difficulty,
      score: result.score,
      stars: result.stars,
      levelLabel: levelLabel(result.level),
      diffLabel: diffLabel(result.difficulty)
    };
    leaderboardData.push(item);
    saveLeaderboard();
    renderLeaderboard();
  }

  // ====== Answer Handling ======
  function handleAnswer(chosenIndex){
    if(!state.inGame || state.isPaused) return;
    const q = state.currentQuestion;
    if(!q) return;

    const isCorrect = chosenIndex === q.correctIndex;
    const optionBtns = optionsContainer.querySelectorAll('.option-btn');
    optionBtns.forEach((btn, idx)=>{
      btn.classList.add('disabled');
      if(idx === q.correctIndex) btn.classList.add('correct');
      if(idx === chosenIndex && !isCorrect) btn.classList.add('wrong');
    });

    if(isCorrect){
      state.combo += 1;
      if(state.combo > state.maxCombo) state.maxCombo = state.combo;

      // è¨ˆåˆ†ï¼šä¾é›£åº¦æ±ºå®šåŸºç¤åˆ†ï¼‹combo åŠ æˆ
      let base = 10;
      if(state.difficulty === 'normal') base = 12;
      else if(state.difficulty === 'hard') base = 15;
      const bonus = Math.round(base * (1 + (state.combo - 1) * 0.25));
      state.score += bonus;

      // æ™‚é–“ +5 ç§’ï¼Œæœ€é«˜åŠ åˆ° 90 ç§’
      state.timeLeft = Math.min(state.timeLeft + 5, 90);

      feedbackEl.className = 'feedback good';
      feedbackEl.textContent = `ç­”å°äº†ï¼æœ¬é¡Œç²å¾— ${bonus} åˆ†ï¼Œæ™‚é–“ +5 ç§’ã€‚${q.explanation ? 'æç¤ºï¼š' + q.explanation : ''}`;
    }else{
      state.combo = 0;
      state.score = Math.max(0, state.score - 5);
      state.timeLeft = Math.max(0, state.timeLeft - 5);

      feedbackEl.className = 'feedback bad';
      feedbackEl.textContent = `å¯æƒœï¼Œç­”éŒ¯äº†ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${q.options[q.correctIndex]}ã€‚${q.explanation ? 'æç¤ºï¼š' + q.explanation : ''}`;
    }

    updateScoreUI();
    updateTimerUI();

    // å¦‚æœæ™‚é–“æ­¸é›¶å°±çµæŸ
    if(state.timeLeft <= 0){
      endGame('æ™‚é–“æ­¸é›¶ï¼ŒçµæŸæœ¬å±€');
      return;
    }

    // ç¨å¾®å»¶é²å†å‡ºä¸‹ä¸€é¡Œ
    setTimeout(()=>{
      if(!state.inGame) return;
      generateQuestion();
    }, 800);
  }

  // ====== äº‹ä»¶ç¶å®š ======
  playerNameInput.addEventListener('input', ()=>{
    const value = playerNameInput.value.trim();
    btnEnterGame.disabled = value.length === 0;
  });

  btnEnterGame.addEventListener('click', ()=>{
    const value = playerNameInput.value.trim();
    if(!value) return;
    state.playerName = value;
    greetingBadge.textContent = 'ç©å®¶ï¼š' + value;
    showScreen('menu');
  });

  // é¸é—œ
  levelButtonsWrap.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-pill-toggle');
    if(!btn) return;
    const level = parseInt(btn.dataset.level,10);
    state.currentLevel = level;

    // æ¨£å¼
    levelButtonsWrap.querySelectorAll('.btn-pill-toggle').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    maybeEnableStartButton();
  });

  // é¸é›£åº¦
  difficultyButtonsWrap.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-pill-toggle');
    if(!btn) return;
    const diff = btn.dataset.diff;
    state.difficulty = diff;

    difficultyButtonsWrap.querySelectorAll('.btn-pill-toggle').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    maybeEnableStartButton();
  });

  function maybeEnableStartButton(){
    btnStartLevel.disabled = !(state.currentLevel && state.difficulty);
  }

  btnStartLevel.addEventListener('click', ()=>{
    if(!(state.currentLevel && state.difficulty)) return;
    showScreen('game');
    startGame();
  });

  // æš«åœ / ç¹¼çºŒ
  btnPause.addEventListener('click', ()=>{
    if(!state.inGame) return;
    state.isPaused = !state.isPaused;
    if(state.isPaused){
      pauseOverlay.style.display = 'flex';
      btnPause.innerHTML = '<i class="fa-solid fa-play"></i><span>ç¹¼çºŒ</span>';
      setOptionsDisabled(true);
    }else{
      pauseOverlay.style.display = 'none';
      btnPause.innerHTML = '<i class="fa-solid fa-pause"></i><span>æš«åœ</span>';
      setOptionsDisabled(false);
    }
  });

  // é‡æ–°æœ¬å±€
  btnRestart.addEventListener('click', ()=>{
    if(!state.currentLevel || !state.difficulty) return;
    startGame();
  });

  // å›é—œå¡ä¸»é¸å–®ï¼ˆæœƒå¯«å…¥æ’è¡Œæ¦œï¼‰
  btnBackToMenu.addEventListener('click', ()=>{
    abortGameToMenu();
  });

  // Modal é—œé–‰
  btnCloseModal.addEventListener('click', ()=>{
    resultModal.classList.remove('active');
  });

  // å­˜å…¥æ’è¡Œæ¦œæŒ‰éˆ•ï¼šåªé¡¯ç¤ºæç¤ºï¼ˆå¯¦éš›å·²è‡ªå‹•å­˜å…¥ï¼‰
  btnSaveRecord.addEventListener('click', ()=>{
    alert('é€™ä¸€å±€çš„æˆç¸¾å·²ç¶“è‡ªå‹•å­˜å…¥æ’è¡Œæ¦œå›‰ï¼');
  });

  // åŒé—œå†æˆ°
  btnPlayAgain.addEventListener('click', ()=>{
    resultModal.classList.remove('active');
    startGame();
  });

  // å¾ Modal å›ä¸»é¸å–®
  btnBackToMenuFromModal.addEventListener('click', ()=>{
    resultModal.classList.remove('active');
    showScreen('menu');
  });

  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', ()=>{
    loadLeaderboard();
    updateTimerUI();
    updateScoreUI();
  });
</script>
</body>
</html>


